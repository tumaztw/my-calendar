<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ™ºæ…§èª²è¡¨</title>
    <style>
        :root { --primary: #2c3e50; --header-bg: #4a90e2; --cell-hover: #e3f2fd; --modal-bg: rgba(0,0,0,0.6); }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 0; padding: 10px; background: #f4f4f4; }
        
        /* === é ‚éƒ¨æ§åˆ¶å€ === */
        .controls { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 15px; background: white; padding: 15px; 
            border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
        }
        .title-group h2 { margin: 0; font-size: 1.3rem; color: var(--primary); }
        .title-group small { color: #888; }

        .nav-group { display: flex; align-items: center; gap: 10px; }
        .nav-btn { background: var(--header-bg); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
        .nav-btn:hover { opacity: 0.9; }
        
        /* æ—¥æœŸé¸æ“‡å™¨æ¨£å¼ */
        input[type="date"] {
            padding: 8px; border: 1px solid #ccc; border-radius: 6px; font-family: inherit; font-size: 1rem;
        }

        /* === æ ¸å¿ƒèª²è¡¨ (ç…§ç‰‡æ¨¡å¼) === */
        .timetable { 
            display: grid; 
            grid-template-columns: 40px repeat(5, 1fr); 
            gap: 3px; 
            background: #ddd; 
            border: 3px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }
        .cell { 
            background: white; 
            min-height: 90px; 
            padding: 5px; 
            text-align: center; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            font-size: 0.95rem;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }
        .cell:hover { background: var(--cell-hover); transform: scale(1.02); z-index: 5; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* è¡¨é ­èˆ‡å´é‚Šæ¬„ */
        .cell.header { background: var(--primary); color: white; font-weight: bold; min-height: 45px; cursor: default; }
        .cell.time-col { background: #e9ecef; color: #555; font-weight: bold; cursor: default; }
        
        /* ä»Šå¤©çš„ç‰¹åˆ¥æ¨™ç¤º */
        .cell.today-col { background: #fffde7; border: 2px solid #ffd700; z-index: 2; } 

        .class-name { font-weight: bold; color: #d35400; font-size: 1.1rem; margin-bottom: 5px; }
        .empty-class { color: #eee; font-size: 2rem; line-height: 0; }

        /* === å½ˆå‡ºè¦–çª— (Modal) === */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--modal-bg); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: white; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: slideIn 0.25s; }
        @keyframes slideIn { from {transform: translateY(15px); opacity: 0;} to {transform: translateY(0); opacity: 1;} }

        /* å…ˆçŸ¥å€å¡Š */
        .prophet-box { background: #fff9db; border-left: 5px solid #f1c40f; padding: 12px; margin-bottom: 20px; border-radius: 4px; font-size: 0.95rem; color: #555; }
        .prophet-title { font-weight: bold; color: #b38f00; margin-bottom: 8px; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.1); padding-bottom: 5px; }
        
        /* è¡¨å–®å€ */
        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 6px; font-size: 0.95rem; color: var(--primary); }
        textarea { width: 100%; height: 70px; padding: 10px; border: 1px solid #ccc; border-radius: 6px; resize: none; box-sizing: border-box; font-size: 1rem; }
        .modal-footer { display: flex; gap: 10px; margin-top: 25px; }
        button.save-btn { flex: 2; background: var(--header-bg); color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        button.cancel-btn { flex: 1; background: #95a5a6; color: white; border: none; padding: 12px; border-radius: 8px; cursor: pointer; }
        
        #loading-text { font-size: 0.8rem; color: #666; font-style: italic; display:none; }

        /* RWD */
        @media (max-width: 600px) {
            .controls { flex-direction: column; align-items: flex-start; gap: 10px; }
            .nav-group { width: 100%; justify-content: space-between; }
            .timetable { grid-template-columns: 25px repeat(5, 1fr); }
            .cell { font-size: 0.8rem; min-height: 70px; padding: 2px; }
            .class-name { font-size: 0.9rem; }
        }
    </style>
</head>
<body>

<div class="controls">
    <div class="title-group">
        <h2 id="monthTitle">2026å¹´ 1æœˆ</h2>
        <small id="dateRange">é€±èª²è¡¨</small>
    </div>
    <div class="nav-group">
        <button class="nav-btn" onclick="changeWeek(-7)">â—€ ä¸Šé€±</button>
        <input type="date" id="weekPicker" onchange="jumpToDate(this.value)">
        <button class="nav-btn" onclick="changeWeek(7)">ä¸‹é€± â–¶</button>
    </div>
</div>

<div class="timetable" id="timetable">
    </div>

<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h3 id="modalTitle" style="margin-top:0; border-bottom:2px solid #eee; padding-bottom:10px; color:var(--primary);">ç·¨è¼¯é€²åº¦</h3>
        
        <div class="prophet-box">
            <div class="prophet-title">
                <span>ğŸ’¡ ä¸Šæ¬¡ä¸Šèª²ç´€éŒ„</span>
                <span id="loading-text">æŸ¥è©¢ä¸­...</span>
            </div>
            <div id="prevContent" style="min-height: 20px;">é»æ“Šæ ¼å­å¾Œè‡ªå‹•æŸ¥è©¢...</div>
        </div>

        <form id="progressForm" action="https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/formResponse" method="post" target="hidden_iframe">
            <input type="hidden" name="entry.1620291828" id="field_date">
            <input type="hidden" name="entry.244862663" id="field_period">

            <div class="form-group">
                <label>ğŸ“– æœ¬æ¬¡æ•™å­¸é€²åº¦</label>
                <textarea name="entry.1001982669" id="in_progress" placeholder="ä»Šå¤©æ•™äº†ä»€éº¼ï¼Ÿ"></textarea>
            </div>
            <div class="form-group">
                <label>ğŸ”” èª²å ‚æé†’</label>
                <textarea name="entry.476700209" id="in_reminder"></textarea>
            </div>
            <div class="form-group">
                <label>ğŸ“ ä½œæ¥­å…§å®¹</label>
                <textarea name="entry.1079052023" id="in_homework"></textarea>
            </div>
            <div class="form-group">
                <label>âœï¸ å¹³æ™‚æ¸¬é©—</label>
                <textarea name="entry.1279670059" id="in_quiz"></textarea>
            </div>

            <div class="modal-footer">
                <button type="button" class="cancel-btn" onclick="closeModal()">å–æ¶ˆ</button>
                <button type="submit" class="save-btn" onclick="submitted=true">ğŸ’¾ å„²å­˜ç´€éŒ„</button>
            </div>
        </form>
    </div>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(typeof submitted !== 'undefined' && submitted){alert('å„²å­˜æˆåŠŸï¼'); closeModal();}"></iframe>

<script>
    const SHEET_ID = '1SlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD';
    let currentMonday = new Date();
    
    // åˆå§‹åŒ–ï¼šå®šä½åˆ°æœ¬é€±ä¸€
    const day = currentMonday.getDay() || 7; 
    if(day !== 1) currentMonday.setDate(currentMonday.getDate() - day + 1);

    // æ‚¨çš„èª²è¡¨
    const schedule = {
        1: {1:"109 åœ‹æ–‡", 2:"117 åœ‹æ–‡", 4:"116 åœ‹æ–‡"},
        2: {2:"116 åœ‹æ–‡", 3:"109 åœ‹æ–‡", 5:"117 åœ‹æ–‡", 7:"116 é–±è®€"},
        3: {2:"109 åœ‹æ–‡", 3:"116 åœ‹æ–‡", 7:"117 åœ‹æ–‡"},
        4: {1:"109 åœ‹æ–‡", 3:"117 åœ‹æ–‡", 4:"116 åœ‹æ–‡", 6:"109 é–±è®€"},
        5: {2:"116 åœ‹æ–‡", 5:"117 åœ‹æ–‡", 7:"109 åœ‹æ–‡"}
    };

    window.onload = function() { 
        // é è¨­é¸å–®ç‚ºä»Šå¤©
        document.getElementById('weekPicker').value = new Date().toISOString().split('T')[0];
        renderTimetable(); 
    };

    // åˆ‡æ›é€±æ¬¡
    function changeWeek(offset) {
        currentMonday.setDate(currentMonday.getDate() + offset);
        updatePickerAndRender();
    }

    // æŒ‡å®šæ—¥æœŸè·³è½‰
    function jumpToDate(val) {
        if(!val) return;
        const targetDate = new Date(val);
        const d = targetDate.getDay() || 7;
        targetDate.setDate(targetDate.getDate() - d + 1); // æ‰¾å‡ºè©²é€±é€±ä¸€
        currentMonday = targetDate;
        renderTimetable();
    }

    function updatePickerAndRender() {
        // æ›´æ–° picker é¡¯ç¤ºç‚ºè©²é€±é€±ä¸€ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…çŸ¥é“ç›®å‰åœ¨å“ª
        document.getElementById('weekPicker').value = currentMonday.toISOString().split('T')[0];
        renderTimetable();
    }

    function renderTimetable() {
        const container = document.getElementById('timetable');
        container.innerHTML = '';
        
        // æ¨™é¡Œèˆ‡æ—¥æœŸ
        document.getElementById('monthTitle').innerText = `${currentMonday.getFullYear()}å¹´ ${currentMonday.getMonth()+1}æœˆ`;
        let endDay = new Date(currentMonday);
        endDay.setDate(endDay.getDate() + 4);
        document.getElementById('dateRange').innerText = `${currentMonday.getDate()}æ—¥ ~ ${endDay.getDate()}æ—¥`;

        // æ¸²æŸ“è¡¨é ­
        container.appendChild(createDiv('header', 'ç¯€æ¬¡'));
        const weekDays = ['é€±ä¸€', 'é€±äºŒ', 'é€±ä¸‰', 'é€±å››', 'é€±äº”'];
        const todayStr = new Date().toISOString().split('T')[0];

        for(let i=0; i<5; i++) {
            let d = new Date(currentMonday);
            d.setDate(currentMonday.getDate() + i);
            let dateStr = `${d.getMonth()+1}/${d.getDate()}`;
            let fullDate = d.toISOString().split('T')[0];
            let isToday = (fullDate === todayStr);
            
            container.appendChild(createDiv(isToday ? 'header today-col' : 'header', `${weekDays[i]}<br><span style="font-size:0.75em; font-weight:normal;">${dateStr}</span>`));
        }

        // æ¸²æŸ“ 1~8 ç¯€
        for(let p=1; p<=8; p++) {
            container.appendChild(createDiv('time-col', `ç¬¬${p}ç¯€`));
            
            for(let d=1; d<=5; d++) {
                let cellDate = new Date(currentMonday);
                cellDate.setDate(currentMonday.getDate() + (d-1));
                let dateKey = cellDate.toISOString().split('T')[0];
                let isToday = (dateKey === todayStr);

                let className = schedule[d]?.[p] || "";
                
                let cellDiv = document.createElement('div');
                cellDiv.className = isToday ? 'cell today-col' : 'cell';
                
                if(className) {
                    cellDiv.innerHTML = `<div class="class-name">${className}</div>`;
                    cellDiv.onclick = () => openModal(className, dateKey, p);
                } else {
                    cellDiv.innerHTML = `<span class="empty-class">Â·</span>`;
                }

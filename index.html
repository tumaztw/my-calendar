<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿ (æ™ºæ…§æª¢æŸ¥ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #4a6fa5; --bg-color: #f4f7f6; --card-bg: #ffffff; --accent-color: #d84315; --success-color: #2ecc71; --error-color: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; }
        .header { text-align: center; margin-bottom: 20px; }
        .date-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; }
        .nav-btn { background: white; border: 2px solid var(--primary-color); color: var(--primary-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 18px; }
        .date-display { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 60px; }
        .class-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden; border-left: 6px solid var(--primary-color); }
        .card-header { background-color: #eef2f7; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header .class-name { font-weight: bold; font-size: 1.1rem; color: #333; }
        .card-body { padding: 15px; }
        .last-record { background-color: #fff8e1; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffe0b2; font-size: 0.95rem; line-height: 1.6; }
        .last-record h4 { margin: 0 0 8px 0; color: #e65100; border-bottom: 1px dashed #ffcc80; font-size: 1rem; display: flex; justify-content: space-between; }
        .info-row { display: flex; margin-bottom: 4px; align-items: flex-start; }
        .info-label { min-width: 45px; font-weight: bold; color: #555; white-space: nowrap; }
        .info-content { flex: 1; word-break: break-word; white-space: pre-wrap; }
        .check-panel { background-color: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; margin-bottom: 10px; transition: background-color 0.3s; }
        .check-panel.all-clear { background-color: #e8f5e9; border-color: #a5d6a7; }
        .panel-title { font-weight: bold; margin-bottom: 8px; color: #1565c0; display: block; }
        .hw-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .hw-chip { background: white; border: 1px solid #90caf9; color: #1565c0; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.95rem; user-select: none; }
        .hw-chip.active { background: #1565c0; color: white; border-color: #1565c0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .hw-input { width: 100%; padding: 10px; border: 1px solid #90caf9; border-radius: 4px; box-sizing: border-box; margin-bottom: 12px; font-size: 1rem; }
        .number-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 8px; }
        .num-btn { height: 42px; border: 1px solid #bbdefb; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; color: #555; font-weight: 500; font-size: 1.1rem; transition: all 0.1s; }
        .num-btn.missing { background: var(--error-color); color: white; border-color: var(--error-color); font-weight: bold; transform: scale(1.05); }
        .btn-submit { display: block; width: 100%; text-align: center; background: var(--primary-color); color: white; padding: 16px; text-decoration: none; border-radius: 8px; font-weight: bold; margin-top: 15px; font-size: 1.1rem; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .all-clear-msg { color: var(--success-color); font-weight: bold; text-align: center; display: none; margin: 10px 0; font-size: 1.2rem; }
        .fab-refresh { position: fixed; bottom: 20px; right: 20px; background: var(--primary-color); color: white; width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 26px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .loading { text-align: center; padding: 40px; color: #666; font-size: 1.1rem; }
    </style>
</head>
<body>

<div class="header">
    <h1>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</h1>
    <div class="date-controls">
        <button class="nav-btn" onclick="changeDate(-1)">â—€</button>
        <span class="date-display" id="dateDisplay"></span>
        <button class="nav-btn" onclick="changeDate(1)">â–¶</button>
    </div>
</div>

<div class="container" id="mainContainer">
    <div class="loading">æ­£åœ¨è®€å–è³‡æ–™åº«...</div>
</div>
<button class="fab-refresh" onclick="location.reload()" title="æ›´æ–°è³‡æ–™">â†»</button>

<script>
    // â˜… æ ¸å¿ƒè¨­å®šå€ â˜…
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv'; 
    const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform?usp=pp_url';
    
    // æ¬„ä½ ID å°ç…§è¡¨
    const entryIds = {
        date: 'entry.1279670059', 
        period: 'entry.1620291828',
        progress: 'entry.244862663', 
        homework: 'entry.1001982669',
        quiz: 'entry.476700209', 
        note: 'entry.1079052023',
        item: 'entry.1450418126', 
        missing: 'entry.551581621'
    };

    const timetable = {
        1: [{p:1, c:'109'}, {p:2, c:'117'}, {p:4, c:'116'}],
        2: [{p:2, c:'116'}, {p:3, c:'109'}, {p:5, c:'117'}, {p:7, c:'116', s:'é–±è®€'}],
        3: [{p:2, c:'109'}, {p:3, c:'116'}, {p:7, c:'117'}],
        4: [{p:1, c:'109'}, {p:3, c:'117'}, {p:4, c:'116'}, {p:6, c:'109', s:'é–±è®€'}],
        5: [{p:2, c:'116'}, {p:5, c:'117'}, {p:7, c:'109'}]
    };

    let g_currentDate = new Date();
    let g_rawRecords = []; 
    let g_selectedMissing = {}; 

    function changeDate(d) { g_currentDate.setDate(g_currentDate.getDate() + d); render(); }

    function fetchData() {
        Papa.parse(csvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => {
                g_rawRecords = results.data;
                render();
            },
            error: (err) => {
                document.getElementById('mainContainer').innerHTML = '<div style="text-align:center;color:red;">è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– CSV é€£çµã€‚</div>';
            }
        });
    }

    function getClassByDateAndPeriod(dateStr, period) {
        const d = new Date(dateStr);
        const day = d.getDay(); 
        const classes = timetable[day];
        if (!classes) return null;
        const target = classes.find(c => c.p == period);
        return target ? target.c : null;
    }

    function parseNums(str) {
        if(!str) return [];
        return str.toString().split(/[,\s\u3001]+/).map(Number).filter(n => !isNaN(n) && n > 0);
    }

    function updateLink(id) {
        const item = document.getElementById(`in-${id}`).value;
        const missing = Array.from(g_selectedMissing[id] || []).sort((a,b)=>a-b).join(' ');
        const dateStr = g_currentDate.toISOString().split('T')[0];
        const p = id.split('-').pop(); 
        const btn = document.getElementById(`btn-${id}`);
        btn.href = `${formUrl}&${entryIds.date}=${dateStr}&${entryIds.period}=${p}&${entryIds.item}=${encodeURIComponent(item)}&${entryIds.missing}=${encodeURIComponent(missing)}`;
    }

    function toggleStudent(id, n, el) {
        if(!g_selectedMissing[id]) g_selectedMissing[id] = new Set();
        const s = g_selectedMissing[id];
        if(s.has(n)) { s.delete(n); el.classList.remove('missing'); }
        else { s.add(n); el.classList.add('missing'); }
        
        const msg = document.getElementById(`msg-${id}`);
        const panel = document.getElementById(`panel-${id}`);
        if(s.size === 0) { msg.style.display = 'block'; panel.classList.add('all-clear'); }
        else { msg.style.display = 'none'; panel.classList.remove('all-clear'); }
        updateLink(id);
    }

    function setItem(id, txt) {
        const input = document.getElementById(`in-${id}`);
        input.value = txt;
        document.querySelectorAll(`#chips-${id} .hw-chip`).forEach(c => {
            c.classList.toggle('active', c.innerText === txt);
        });
        updateLink(id);
    }

    function render() {
        const container = document.getElementById('mainContainer');
        const dateStr = g_currentDate.toISOString().split('T')[0];
        document.getElementById('dateDisplay').innerText = g_currentDate.toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
        
        const day = g_currentDate.getDay();
        const classes = timetable[day] || [];
        
        if(classes.length === 0) { 
            container.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">â˜• ä»Šå¤©æ²’æœ‰æ’èª²ï¼Œå¥½å¥½ä¼‘æ¯ï¼</div>'; 
            return; 
        }

        container.innerHTML = '';
        classes.forEach(c => {
            const id = `${dateStr}-${c.p}`; 
            
            // Proç‰ˆé‚è¼¯ï¼šåªæŠ“åŒç­ç´šç´€éŒ„
            const history = g_rawRecords.filter(r => {
                const rClass = getClassByDateAndPeriod(r['æ—¥æœŸ'], r['ç¯€æ¬¡']);
                return rClass === c.c && r['æ—¥æœŸ'] <= dateStr; 
            }).sort((a,b) => b['æ—¥æœŸ'].localeCompare(a['æ—¥æœŸ']) || b['ç¯€æ¬¡'] - a['ç¯€æ¬¡']);
            
            const displayRow = history[0]; // é»ƒè‰²å€å¡Šï¼šæ°¸é é¡¯ç¤ºæœ€æ–°ä¸€ç­†ï¼ˆå¯èƒ½æ˜¯ä»Šå¤©å‰›å¡«çš„ï¼‰

            // â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ±ºå®šã€Œæª¢æŸ¥æŒ‰éˆ•ã€è¦æŠ“å“ªä¸€å¤©çš„ä½œæ¥­ â˜…
            let checkRow = displayRow;
            let checkTitle = "ä¸Šæ¬¡ä½œæ¥­";

            // å¦‚æœæœ€æ–°é€™ç­†ç´€éŒ„æ˜¯ã€Œä»Šå¤©ã€ï¼Œä»£è¡¨æˆ‘å‰›ä¸Šå®Œèª²å¡«å®Œè¡¨
            // é‚£éº¼ä¸‹æ–¹çš„æª¢æŸ¥æŒ‰éˆ•ï¼Œæ‡‰è©²è¦é¡¯ç¤ºã€Œä¸Šä¸€å ‚èª² (index 1)ã€çš„ä½œæ¥­ï¼Œå› ç‚ºé‚£æ‰æ˜¯ä»Šå¤©è¦æ”¶çš„
            if (displayRow && displayRow['æ—¥æœŸ'] === dateStr && history.length > 1) {
                checkRow = history[1]; // æ”¹æŠ“ä¸Šä¸€ç­†
                checkTitle = `ä¸Šæ¬¡ä½œæ¥­ (${checkRow['æ—¥æœŸ'].slice(5)})`;
            }

            let hwItems = [];
            if(checkRow) {
                // åªæŠ“å–ã€Œä½œæ¥­å…§å®¹ã€ä¾†ç”¢ç”ŸæŒ‰éˆ•
                if(checkRow['ä½œæ¥­å…§å®¹']) hwItems.push(...checkRow['ä½œæ¥­å…§å®¹'].split(/[ã€\n,ï¼Œ]/).map(s=>s.trim()));
            }
            hwItems = [...new Set(hwItems)].filter(s => s && s !== 'ç„¡');

            const card = document.createElement('div');
            card.className = 'class-card';
            
            // ç¼ºäº¤ç´…ç‡ˆï¼šé è¨­è¼‰å…¥ checkRow (ä¸Šä¸€ç­†) çš„ç¼ºäº¤ç´€éŒ„ï¼Œé€™æ¨£æ‰å°æ‡‰å¾—åˆ°ä¸Šé¢çš„æŒ‰éˆ•
            let initialMissing = checkRow ? parseNums(checkRow['ç¼ºäº¤åº§è™Ÿ']) : [];
            if(!g_selectedMissing[id]) g_selectedMissing[id] = new Set(initialMissing);

            card.innerHTML = `
                <div class="card-header">
                    <span>ç¬¬ ${c.p} ç¯€</span>
                    <span class="class-name">${c.c} ç­ - ${c.s || 'åœ‹æ–‡'}</span>
                </div>
                <div class="card-body">
                    <div class="last-record">
                        <h4>ğŸ“… ä¸Šæ¬¡ç´€éŒ„ (${displayRow ? displayRow['æ—¥æœŸ'].slice(5) : 'ç„¡'}) 
                            <span style="font-size:0.8em; color:#888;">${displayRow ? (displayRow['ç¯€æ¬¡']+'ç¯€') : ''}</span>
                        </h4>
                        <div class="info-row"><span class="info-label">é€²åº¦ï¼š</span><span class="info-content">${displayRow ? (displayRow['æ•™å­¸é€²åº¦'] || 'ç„¡') : 'ç„¡'}</span></div>
                        <div class="info-row" style="color:#d84315;"><span class="info-label">ä½œæ¥­ï¼š</span><span class="info-content">${displayRow ? (displayRow['ä½œæ¥­å…§å®¹'] || 'ç„¡') : 'ç„¡'}</span></div>
                        <div class="info-row" style="color:#2e7d32;"><span class="info-label">æ¸¬é©—ï¼š</span><span class="info-content">${displayRow ? (displayRow['å¹³æ™‚æ¸¬é©—'] || 'ç„¡') : 'ç„¡'}</span></div>
                        <div class="info-row"><span class="info-label">ç¼ºäº¤ï¼š</span><span class="info-content">${displayRow ? (displayRow['ç¼ºäº¤åº§è™Ÿ'] || 'ç„¡') : 'ç„¡'}</span></div>
                    </div>
                    
                    <div class="check-panel" id="panel-${id}">
                        <span class="panel-title">ğŸ” æª¢æŸ¥é …ç›®ï¼š${hwItems.length > 0 ? checkTitle : 'ç„¡å¾…æª¢æŸ¥ä½œæ¥­'}</span>
                        
                        <div class="hw-chips" id="chips-${id}">
                            ${hwItems.map(h => `<div class="hw-chip" onclick="setItem('${id}','${h}')">${h}</div>`).join('')}
                            <div class="hw-chip" onclick="setItem('${id}','å…¨éƒ¨')">å…¨éƒ¨</div>
                        </div>
                        
                        <input type="text" class="hw-input" id="in-${id}" placeholder="é»é¸ä¸Šæ–¹æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥..." oninput="updateLink('${id}')">
                        
                        <div class="all-clear-msg" id="msg-${id}">ğŸ‰ æœ¬é …å…¨æ•¸ç¹³æ¸…ï¼</div>
                        
                        <div class="number-grid">
                            ${Array.from({length:40}, (_,i)=>i+1).map(n => `
                                <div class="num-btn ${g_selectedMissing[id].has(n)?'missing':''}" onclick="toggleStudent('${id}',${n},this)">${n}</div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <a href="#" target="_blank" class="btn-submit" id="btn-${id}" onclick="this.innerText='âœ… å·²é–‹å•Ÿè¡¨å–®';">ğŸš€ å¡«å¯«é€²åº¦</a>
                </div>
            `;
            container.appendChild(card);
            updateLink(id);
        });
    }

    fetchData();
</script>
</body>
</html>

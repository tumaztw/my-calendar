<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;600;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- æ–‡é’é…è‰²ç›¤ --- */
            --bg-color: #f9f7f2;       /* ç±³ç™½ç´™å¼µè‰² */
            --card-bg: #ffffff;        /* ç´”ç™½å¡ç‰‡ */
            --primary-color: #5d7583;  /* è«è˜­è¿ªè—ç° (å¢¨è‰²æ„Ÿ) */
            --text-main: #3e3e3e;      /* æ·±ç°é»‘ (ä¸è¦ç´”é»‘) */
            --text-sub: #7a7a7a;       /* æ·ºç° */
            --accent-color: #a65e5e;   /* ä¹¾ç‡¥ç«ç‘°/é™¶åœŸç´… */
            --highlight-bg: #f4f4ef;   /* æ·ºç±³ç°è£é£¾å€å¡Š */
            --line-color: #e0ded9;     /* æŸ”å’Œçš„åˆ†éš”ç·š */
            
            /* é–±è®€æŒ‡å°èª²çš„ç‰¹æ®Šè‰² (æŠ¹èŒ¶ç¶ ) */
            --reading-color: #6a8c6d; 
        }

        body {
            /* æ”¹ç”¨æ€æºå®‹é«”ï¼Œæ›¸å·æ°£ç¬é–“æå‡ */
            font-family: "Noto Serif TC", "Songti TC", serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 40px 20px;
            color: var(--text-main);
            background-image: radial-gradient(#e8e6e1 1px, transparent 1px);
            background-size: 20px 20px; /* å¢åŠ ä¸€é»é»ç´™å¼µé¡†ç²’æ„Ÿ */
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            position: relative;
        }

        .header h1 {
            font-weight: 900;
            letter-spacing: 0.1em;
            color: var(--primary-color);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
            display: inline-block;
            padding-bottom: 10px;
        }

        .date-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 25px;
            margin-top: 25px;
            user-select: none;
        }

        .nav-btn {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            width: 45px;
            height: 45px;
            border-radius: 50%; /* åœ“å½¢ */
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .nav-btn:hover {
            background-color: var(--primary-color);
            color: #fff;
            transform: translateY(-2px);
        }

        .date-display {
            font-size: 1.5rem;
            color: var(--text-main);
            font-weight: 600;
            min-width: 220px;
            text-align: center;
            letter-spacing: 0.05em;
        }
        
        .container {
            max-width: 750px;
            margin: 0 auto;
        }

        /* å¡ç‰‡è¨­è¨ˆï¼šç°¡ç´„ã€ç•™ç™½ã€æŸ”å’Œé™°å½± */
        .class-card {
            background: var(--card-bg);
            border-radius: 8px; /* åœ“è§’æ”¹å°ä¸€é»ï¼Œæ¯”è¼ƒä¿è½ */
            box-shadow: 0 10px 30px -10px rgba(0,0,0,0.06); /* å¾ˆæ·¡çš„æŸ”å’Œé™°å½± */
            margin-bottom: 30px;
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
        }

        .class-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px -10px rgba(0,0,0,0.1);
        }

        /* é ‚éƒ¨è£é£¾æ¢ï¼Œå–ä»£åŸæœ¬å·¦é‚Šçš„ç²—ç·š */
        .class-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--primary-color);
            opacity: 0.7;
        }

        .card-header {
            padding: 25px 30px 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fff;
        }

        /* --- ç¯€æ¬¡å¾½ç«  (æ–‡é’ç‰ˆ) --- */
        .period-badge {
            background-color: var(--primary-color);
            color: #fff;
            padding: 8px 24px;       
            border-radius: 50px;     
            font-size: 1.25rem;       
            font-weight: 600;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 10px rgba(93, 117, 131, 0.3); /* é…åˆä¸»è‰²çš„é™°å½± */
            display: inline-flex;
            align-items: center;
        }

        .class-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text-main);
            letter-spacing: 0.05em;
        }

        .card-body {
            padding: 0 30px 30px 30px;
        }

        /* ç´€éŒ„å€å¡Šï¼šæ¨¡ä»¿ç­†è¨˜æœ¬æˆ–ä¾¿æ¢ç´™ */
        .last-record {
            background-color: var(--highlight-bg);
            padding: 20px;
            border-radius: 4px;
            margin-bottom: 25px;
            font-size: 1rem;
            /* è™›ç·šé‚Šæ¡†ï¼Œåƒå‰ªè²¼ç°¿ */
            border: 1px dashed var(--line-color); 
            position: relative;
        }

        .last-record h4 {
            margin: 0 0 15px 0;
            color: var(--accent-color);
            font-size: 1.05rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--line-color);
        }

        .record-item {
            margin-bottom: 10px;
            line-height: 1.8; /* è¡Œè·åŠ å¤§ï¼Œé–±è®€æ›´èˆ’æœ */
            display: flex;
            align-items: baseline;
        }

        .record-label {
            font-weight: 600;
            color: var(--text-sub);
            min-width: 55px;
            flex-shrink: 0;
            font-size: 0.95rem;
        }

        .record-content {
            color: var(--text-main);
            word-break: break-word;
        }

        /* æŒ‰éˆ•ï¼šæ¥µç°¡é¢¨æ ¼ */
        .btn-add {
            display: block;
            width: 100%;
            text-align: center;
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: 12px;
            text-decoration: none;
            border-radius: 4px;
            font-weight: 600;
            font-size: 1.05rem;
            transition: all 0.3s;
            letter-spacing: 0.1em;
        }

        .btn-add:hover {
            background-color: var(--primary-color);
            color: #fff;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-sub);
            font-size: 1.1rem;
            letter-spacing: 0.1em;
        }

        .no-class {
            text-align: center;
            padding: 60px;
            background: var(--card-bg);
            border-radius: 8px;
            color: var(--text-sub);
            border: 1px dashed var(--line-color);
            letter-spacing: 0.1em;
        }

        /* --- é–±è®€æŒ‡å°èª²çš„ç‰¹æ®Šæ¨£å¼ (æŠ¹èŒ¶ç¶ ) --- */
        .type-reading .period-badge {
            background-color: var(--reading-color);
            box-shadow: 0 4px 10px rgba(106, 140, 109, 0.3);
        }
        .type-reading::before {
            background-color: var(--reading-color);
        }
        .type-reading .btn-add {
            color: var(--reading-color);
            border-color: var(--reading-color);
        }
        .type-reading .btn-add:hover {
            background-color: var(--reading-color);
            color: white;
        }
        
        /* æ‰‹æ©Ÿç‰ˆå¾®èª¿ */
        @media (max-width: 600px) {
            body { padding: 20px 10px; }
            .card-header { padding: 20px; flex-direction: column; gap: 15px; align-items: flex-start; }
            .period-badge { font-size: 1.1rem; padding: 6px 20px; }
        }
    </style>
</head>
<body>

<div class="header">
    <h1>æ•™å­¸é€²åº¦ï¼æ—¥èªŒ</h1>
    
    <div class="date-controls">
        <button class="nav-btn" onclick="changeDate(-1)">â—€</button>
        <div class="date-display" id="currentDateDisplay"></div>
        <button class="nav-btn" onclick="changeDate(1)">â–¶</button>
    </div>
</div>

<div class="container" id="scheduleContainer">
    <div class="loading">
        <p>æ­£åœ¨å±•å·è®€å–ä¸­...</p>
    </div>
</div>

<script>
    // ==========================================
    // â˜… è¨­å®šå€
    // ==========================================
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv';
    const formBaseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform?usp=pp_url';
    
    const entryIds = {
        date: 'entry.1279670059',
        period: 'entry.1620291828'
    };

    const timetable = {
        1: [
            { period: 1, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 2, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 4, class: '116', subject: 'åœ‹èªæ–‡' }
        ],
        2: [
            { period: 2, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 3, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 5, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 7, class: '116', subject: 'é–±è®€æŒ‡å°' }
        ],
        3: [
            { period: 2, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 3, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 7, class: '117', subject: 'åœ‹èªæ–‡' }
        ],
        4: [
            { period: 1, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 3, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 4, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 6, class: '109', subject: 'é–±è®€æŒ‡å°' }
        ],
        5: [
            { period: 2, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 5, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 7, class: '109', subject: 'åœ‹èªæ–‡' }
        ]
    };

    // ==========================================
    // â˜… ç¨‹å¼é‚è¼¯å€
    // ==========================================

    let g_currentDate = new Date();
    let g_csvData = []; 
    let g_classRecords = {}; 

    document.addEventListener('DOMContentLoaded', () => {
        fetchData();
    });

    function changeDate(days) {
        g_currentDate.setDate(g_currentDate.getDate() + days);
        renderSchedule();
    }

    function fetchData() {
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                g_csvData = results.data;
                processData();
                renderSchedule();
            },
            error: function(err) {
                console.error("Error:", err);
                document.getElementById('scheduleContainer').innerHTML = '<div class="no-class">ç„¡æ³•è®€å–è³‡æ–™ã€‚</div>';
            }
        });
    }

    function getCourseObjByDateAndPeriod(dateStr, period) {
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj)) return null;
        
        const dayOfWeek = dateObj.getDay();
        if (!timetable[dayOfWeek]) return null;
        
        const course = timetable[dayOfWeek].find(c => c.period == period);
        return course ? course : null;
    }

    function processData() {
        g_classRecords = {}; 
        
        g_csvData.forEach(row => {
            const date = row['æ—¥æœŸ']; 
            const period = row['ç¯€æ¬¡']; 
            
            if (date && period) {
                const courseObj = getCourseObjByDateAndPeriod(date, period);
                
                if (courseObj) {
                    const uniqueKey = `${courseObj.class}_${courseObj.subject}`;
                    if (!g_classRecords[uniqueKey] || date > g_classRecords[uniqueKey]['æ—¥æœŸ']) {
                        g_classRecords[uniqueKey] = row;
                    }
                }
            }
        });
    }

    function renderSchedule() {
        const container = document.getElementById('scheduleContainer');
        const dateDisplay = document.getElementById('currentDateDisplay');
        
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        dateDisplay.textContent = g_currentDate.toLocaleDateString('zh-TW', options);

        container.innerHTML = '';

        const dayOfWeek = g_currentDate.getDay();
        
        const y = g_currentDate.getFullYear();
        const m = String(g_currentDate.getMonth() + 1).padStart(2, '0');
        const d = String(g_currentDate.getDate()).padStart(2, '0');
        const dateStr = `${y}-${m}-${d}`;

        if (!timetable[dayOfWeek]) {
            container.innerHTML = '<div class="no-class">â˜• æœ¬æ—¥ç„¡èª²ï¼Œå®œé–±è®€ã€å®œæ²ˆæ¾±ã€‚</div>';
            return;
        }

        const todaysClasses = timetable[dayOfWeek];
        const sortedClasses = [...todaysClasses].sort((a, b) => a.period - b.period);

        sortedClasses.forEach(course => {
            const uniqueKey = `${course.class}_${course.subject}`;
            const lastRecord = g_classRecords[uniqueKey];
            
            const formLink = `${formBaseUrl}&${entryIds.date}=${dateStr}&${entryIds.period}=${course.period}`;

            const card = document.createElement('div');
            card.className = `class-card ${course.subject === 'é–±è®€æŒ‡å°' ? 'type-reading' : ''}`;
            
            let recordHtml = '';
            if (lastRecord) {
                const recordDateObj = new Date(lastRecord['æ—¥æœŸ']);
                const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
                const weekStr = days[recordDateObj.getDay()]; 
                
                const shortDate = `${recordDateObj.getMonth() + 1}/${recordDateObj.getDate()}`;

                recordHtml = `
                    <div class="last-record">
                        <h4>ğŸ”– ä¸Šæ¬¡ç´€éŒ„ (${shortDate} ${weekStr} - ç¬¬ ${lastRecord['ç¯€æ¬¡']} ç¯€)</h4>
                        <div class="record-item">
                            <span class="record-label">é€²åº¦</span>
                            <span class="record-content">${lastRecord['æ•™å­¸é€²åº¦'] || 'ç„¡'}</span>
                        </div>
                        <div class="record-item">
                            <span class="record-label">ä½œæ¥­</span>
                            <span class="record-content">${lastRecord['ä½œæ¥­å…§å®¹'] || 'ç„¡'}</span>
                        </div>
                        <div class="record-item">
                            <span class="record-label">æé†’</span>
                            <span class="record-content">${lastRecord['èª²å ‚æé†’'] || 'ç„¡'}</span>
                        </div>
                        ${lastRecord['å¹³æ™‚æ¸¬é©—'] ? `
                        <div class="record-item">
                            <span class="record-label">æ¸¬é©—</span>
                            <span class="record-content">${lastRecord['å¹³æ™‚æ¸¬é©—']}</span>
                        </div>` : ''}
                    </div>
                `;
            } else {
                recordHtml = `
                    <div class="last-record" style="background-color: transparent; border: 1px dashed #ccc; color: #999;">
                        å°šç„¡æ­¤èª²ç¨‹ (${course.class}${course.subject}) çš„éå¾€ç¯‡ç« 
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="card-header">
                    <span class="period-badge">ç¬¬ ${course.period} ç¯€</span>
                    <span class="class-title">${course.class} ç­ â€§ ${course.subject}</span>
                </div>
                <div class="card-body">
                    ${recordHtml}
                    <a href="${formLink}" target="_blank" class="btn-add">
                        âœï¸ å¡«å¯«é€²åº¦
                    </a>
                </div>
            `;
            container.appendChild(card);
        });
    }
</script>

</body>
</html>

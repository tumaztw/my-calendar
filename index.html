<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸æ—¥èªŒ - æ™ºæ…§é€£å‹•ç‰ˆ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --history: #fdf6e3; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .date-nav { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: #eef2f7; padding: 10px; border-radius: 8px; }
        .date-nav input { border: 1px solid #ccc; padding: 5px; border-radius: 4px; }
        
        .form-group { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: var(--primary); }
        
        /* æ­·å²ç´€éŒ„æ¡† */
        .history-view { font-size: 0.9rem; color: #666; background: var(--history); padding: 8px; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #b58900; min-height: 20px; }
        
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 60px; }
        
        button.submit-btn { width: 100%; padding: 15px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #loading-msg { color: var(--accent); text-align: center; font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin-top:0; color:var(--primary);">ğŸ“… æ•™å­¸é€²åº¦æ™ºæ…§ç´€éŒ„</h2>

    <div class="date-nav">
        <button onclick="changeDate(-1)">â—€</button>
        <input type="date" id="targetDate" onchange="fetchHistory()">
        <button onclick="changeDate(1)">â–¶</button>
    </div>

    <div id="loading-msg">æ­£åœ¨æŸ¥è©¢é›²ç«¯é€²åº¦...</div>

    <form id="progressForm" action="https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/formResponse" method="post" target="hidden_iframe">
        
        <input type="hidden" name="entry.1620291828" id="hidden_date">
        
        <div class="form-group">
            <label>â° æˆèª²ç¯€æ¬¡</label>
            <select name="entry.244862663" id="targetPeriod" onchange="fetchHistory()">
                <option value="1">ç¬¬ä¸€ç¯€</option><option value="2">ç¬¬äºŒç¯€</option>
                <option value="3">ç¬¬ä¸‰ç¯€</option><option value="4">ç¬¬å››ç¯€</option>
                <option value="5">ç¬¬äº”ç¯€</option><option value="6">ç¬¬å…­ç¯€</option>
                <option value="7">ç¬¬ä¸ƒç¯€</option><option value="8">ç¬¬å…«ç¯€</option>
            </select>
        </div>

        <div class="form-group">
            <label>ğŸ“– æ•™å­¸é€²åº¦</label>
            <div id="view_progress" class="history-view">æŸ¥ç„¡ç´€éŒ„</div>
            <textarea name="entry.1001982669" id="in_progress" placeholder="è¼¸å…¥ä»Šæ—¥æ–°é€²åº¦..."></textarea>
        </div>

        <div class="form-group">
            <label>ğŸ”” èª²å ‚æé†’</label>
            <div id="view_reminder" class="history-view">æŸ¥ç„¡ç´€éŒ„</div>
            <textarea name="entry.476700209" id="in_reminder" placeholder="å¡«å¯«æé†’äº‹é …..."></textarea>
        </div>

        <div class="form-group">
            <label>ğŸ“ ä½œæ¥­å…§å®¹</label>
            <div id="view_homework" class="history-view">æŸ¥ç„¡ç´€éŒ„</div>
            <textarea name="entry.1079052023" id="in_homework" placeholder="å¡«å¯«ä½œæ¥­..."></textarea>
        </div>

        <div class="form-group">
            <label>âœï¸ å¹³æ™‚æ¸¬é©—</label>
            <div id="view_quiz" class="history-view">æŸ¥ç„¡ç´€éŒ„</div>
            <textarea name="entry.1279670059" id="in_quiz" placeholder="å¡«å¯«å°è€ƒå…§å®¹..."></textarea>
        </div>

        <button type="submit" class="submit-btn" onclick="submitted=true">ğŸ’¾ ç¢ºèªå„²å­˜ç´€éŒ„</button>
    </form>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(typeof submitted !== 'undefined' && submitted){alert('å„²å­˜æˆåŠŸï¼'); location.reload();}"></iframe>

<script>
    // æ‚¨çš„è©¦ç®—è¡¨ ID
    const SHEET_ID = '1SlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD';
    
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('targetDate').value = today;
        fetchHistory();
    };

    function changeDate(days) {
        const d = new Date(document.getElementById('targetDate').value);
        d.setDate(d.getDate() + days);
        document.getElementById('targetDate').value = d.toISOString().split('T')[0];
        fetchHistory();
    }

    async function fetchHistory() {
        const date = document.getElementById('targetDate').value;
        const period = document.getElementById('targetPeriod').value;
        document.getElementById('hidden_date').value = date;
        document.getElementById('loading-msg').style.display = 'block';

        try {
            // è®€å–ç™¼ä½ˆçš„ CSV è³‡æ–™
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
            const resp = await fetch(url);
            const csv = await resp.text();
            
            // è§£æ CSV è¡Œ
            const rows = csv.split('\n').map(r => r.split('","').map(c => c.replace(/"/g, '')));
            
            // æœå°‹åŒ¹é…çš„æœ€æ–°ä¸€ç­† (å¾å¾Œå¾€å‰æ‰¾)
            let found = null;
            for (let i = rows.length - 1; i >= 0; i--) {
                if (rows[i][1] === date && rows[i][2] === period) {
                    found = rows[i];
                    break;
                }
            }

            if (found) {
                updateUI('view_progress', 'in_progress', found[3]);
                updateUI('view_reminder', 'in_reminder', found[4]);
                updateUI('view_homework', 'in_homework', found[5]);
                updateUI('view_quiz', 'in_quiz', found[6]);
            } else {
                ['progress', 'reminder', 'homework', 'quiz'].forEach(f => {
                    document.getElementById('view_'+f).innerText = "ï¼ˆç•¶å¤©æ­¤ç¯€ç„¡ç´€éŒ„ï¼‰";
                    document.getElementById('in_'+f).value = "";
                });
            }
        } catch (e) {
            console.error("è®€å–å¤±æ•—", e);
        }
        document.getElementById('loading-msg').style.display = 'none';
    }

    function updateUI(viewId, inId, value) {
        const val = value || "ç„¡å…§å®¹";
        document.getElementById(viewId).innerText = "ä¸Šæ¬¡ç´€éŒ„ï¼š" + val;
        document.getElementById(inId).value = (value === "ç„¡å…§å®¹") ? "" : val;
    }
</script>
</body>
</html>

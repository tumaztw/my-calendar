<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸æ—¥èªŒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 min-h-screen pb-12">
    <div class="max-w-md mx-auto bg-white min-h-screen shadow-2xl flex flex-col">
        <div class="bg-indigo-700 p-6 text-white text-center shadow-lg">
            <h1 class="text-xl font-bold tracking-tight">å¼µå…è’¼è€å¸« æ•™å­¸çœ‹æ¿</h1>
            <p class="text-[10px] opacity-80 mt-1 uppercase">Fushan Junior High School â€¢ 114-1</p>
        </div>

        <div class="flex items-center justify-between p-4 bg-white/90 backdrop-blur sticky top-0 border-b z-50">
            <button onclick="changeWeek(-1)" class="w-12 h-10 flex items-center justify-center bg-slate-100 rounded-xl">â—€</button>
            <div id="week-label" class="font-black text-indigo-900 text-lg">è®€å–ä¸­...</div>
            <button onclick="changeWeek(1)" class="w-12 h-10 flex items-center justify-center bg-slate-100 rounded-xl">â–¶</button>
        </div>

        <div id="main-list" class="flex-1 p-4 space-y-6"></div>

        <div class="px-6 py-4 bg-slate-50 text-[10px] text-gray-400 border-t text-center">
            ğŸ“ æ¥ æ¢“ â‡„ å·¦ç‡Ÿé‡ä¿¡è·¯ â€¢ è³‡æ–™å³æ™‚åŒæ­¥ä¸­
        </div>
    </div>

    <script>
        const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv";
        const formBaseUrl = "https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform";
        const dateId = "entry.1279670059"; 
        const periodId = "entry.1620291828";

        // ä¾æ“šæ•™å¸«èª²è¡¨è¨­å®š
        const baseSchedule = {
            1: { 1: "109 åœ‹èª", 2: "117 åœ‹èª", 4: "116 åœ‹èª" },
            2: { 2: "116 åœ‹èª", 3: "109 åœ‹èª", 5: "117 åœ‹èª", 7: "116 é–±è®€" },
            3: { 2: "109 åœ‹èª", 3: "116 åœ‹èª", 7: "117 åœ‹èª" },
            4: { 1: "109 åœ‹èª", 3: "117 åœ‹èª", 4: "116 åœ‹èª", 6: "109 é–±è®€" },
            5: { 2: "116 åœ‹èª", 5: "117 åœ‹èª", 7: "109 åœ‹èª" }
        };

        let notesData = []; 
        let anchor = new Date();

        async function fetchNotes() {
            try {
                const res = await fetch(csvUrl);
                const text = await res.text();
                const rows = text.split('\n').slice(1);
                notesData = rows.map(r => {
                    const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/);
                    return { 
                        d: c[1]?.replace(/"/g, '').trim(), // æ—¥æœŸåœ¨ç¬¬ 2 æ¬„
                        p: c[2]?.replace(/"/g, '').trim(), // ç¯€æ¬¡åœ¨ç¬¬ 3 æ¬„
                        t: c[3]?.replace(/"/g, '').trim()  // é€²åº¦åœ¨ç¬¬ 4 æ¬„
                    };
                });
            } catch (e) {}
            render();
        }

        function render() {
            const list = document.getElementById('main-list');
            const label = document.getElementById('week-label');
            list.innerHTML = '';
            
            let curr = new Date(anchor);
            let day = curr.getDay();
            let diff = curr.getDate() - day + (day === 0 ? -6 : 1);
            let monday = new Date(curr.setDate(diff));

            label.innerText = `${monday.getMonth()+1}/${monday.getDate()} - ${new Date(new Date(monday).setDate(monday.getDate()+6)).toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'})}`;

            for (let i = 0; i < 7; i++) {
                let d = new Date(monday);
                d.setDate(monday.getDate() + i);
                let dStr = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                let isToday = new Date().toDateString() === d.toDateString();
                let weekday = d.getDay();

                let classes = baseSchedule[weekday] || {};
                let classHtml = Object.entries(classes).map(([p, n]) => {
                    // æ¯”å°è³‡æ–™åº«å…§å®¹
                    const note = notesData.find(note => note.d === dStr && String(note.p) === String(p));
                    const smartUrl = `${formBaseUrl}?usp=pp_url&${dateId}=${dStr}&${periodId}=${p}`;

                    return `
                    <div class="py-3 border-b border-slate-50 last:border-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <span class="text-[10px] font-black text-indigo-500 uppercase">ç¬¬ ${p} ç¯€</span>
                                <div class="text-sm font-bold text-slate-700">${n}</div>
                            </div>
                            <a href="${smartUrl}" target="_blank" class="text-[10px] bg-slate-100 text-slate-500 px-3 py-1.5 rounded-lg font-bold">ğŸ–Šï¸ è¨˜é€²åº¦</a>
                        </div>
                        ${note ? `<div class="mt-2 bg-amber-50 border-l-4 border-amber-400 p-2 text-[11px] text-amber-900 rounded">ğŸ“ ${note.t}</div>` : ''}
                    </div>`;
                }).join('');

                list.innerHTML += `
                    <div class="p-5 bg-white rounded-3xl shadow-sm border ${isToday ? 'border-indigo-500 ring-2 ring-indigo-50' : 'border-slate-100'}">
                        <div class="flex items-center gap-2 mb-4">
                            <span class="text-2xl font-black ${isToday ? 'text-indigo-600' : 'text-slate-400'}">${d.getDate()}</span>
                            <span class="text-xs font-bold text-slate-400">${["é€±æ—¥","é€±ä¸€","é€±äºŒ","é€±ä¸‰","é€±å››","é€±äº”","é€±å…­"][weekday]}</span>
                        </div>
                        <div class="space-y-1">${classHtml || '<p class="text-[10px] text-slate-300 italic text-center py-2">æœ¬æ—¥ç„¡èª²ç¨‹</p>'}</div>
                    </div>`;
            }
        }

        function changeWeek(n) { anchor.setDate(anchor.getDate()+(n*7)); render(); }
        fetchNotes();
    </script>
</body>
</html>

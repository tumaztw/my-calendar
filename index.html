<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #4a6fa5; --bg-color: #f4f7f6; --card-bg: #ffffff; --accent-color: #d84315; --success-color: #2ecc71; --error-color: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; }
        .header { text-align: center; margin-bottom: 20px; }
        .date-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; }
        .nav-btn { background: white; border: 2px solid var(--primary-color); color: var(--primary-color); width: 35px; height: 35px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .date-display { font-size: 1.1rem; font-weight: bold; color: var(--primary-color); }
        .container { max-width: 800px; margin: 0 auto; }
        .class-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 20px; overflow: hidden; border-left: 6px solid var(--primary-color); }
        .card-header { background-color: #eef2f7; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 15px; }
        .last-record { background-color: #fff8e1; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffe0b2; font-size: 0.95rem; line-height: 1.6; }
        .last-record h4 { margin: 0 0 8px 0; color: #e65100; border-bottom: 1px dashed #ffcc80; }
        .check-panel { background-color: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; margin-bottom: 10px; }
        .check-panel.all-clear { background-color: #e8f5e9; border-color: #a5d6a7; }
        .hw-chips { display: flex; flex-wrap: wrap; gap: 8px; margin: 10px 0; }
        .hw-chip { background: white; border: 1px solid #90caf9; color: #1565c0; padding: 5px 12px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; }
        .hw-chip.active { background: #1565c0; color: white; border-color: #1565c0; }
        .hw-input { width: 100%; padding: 8px; border: 1px solid #90caf9; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 1rem; }
        .number-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; }
        .num-btn { height: 40px; border: 1px solid #bbdefb; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; color: #555; font-weight: 500; }
        .num-btn.missing { background: var(--error-color); color: white; border-color: var(--error-color); }
        .btn-submit { display: block; width: 100%; text-align: center; background: var(--primary-color); color: white; padding: 15px; text-decoration: none; border-radius: 8px; font-weight: bold; margin-top: 15px; font-size: 1.1rem; border: none; }
        .all-clear-msg { color: var(--success-color); font-weight: bold; text-align: center; display: none; margin: 10px 0; font-size: 1.1rem; }
        .fab-refresh { position: fixed; bottom: 20px; right: 20px; background: var(--primary-color); color: white; width: 55px; height: 55px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; }
    </style>
</head>
<body>

<div class="header">
    <h1>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</h1>
    <div class="date-controls">
        <button class="nav-btn" onclick="changeDate(-1)">â—€</button>
        <span class="date-display" id="dateDisplay"></span>
        <button class="nav-btn" onclick="changeDate(1)">â–¶</button>
    </div>
</div>

<div class="container" id="mainContainer">æ­£åœ¨è®€å–æœ€æ–°è³‡æ–™...</div>
<button class="fab-refresh" onclick="location.reload()">â†»</button>

<script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv'; 
    const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform?usp=pp_url';
    
    const entryIds = {
        date: 'entry.1279670059', period: 'entry.1620291828',
        progress: 'entry.244862663', homework: 'entry.1001982669',
        quiz: 'entry.476700209', note: 'entry.1079052023',
        item: 'entry.1450418126', missing: 'entry.551581621'
    };

    const timetable = {
        1: [{p:1, c:'109'}, {p:2, c:'117'}, {p:4, c:'116'}],
        2: [{p:2, c:'116'}, {p:3, c:'109'}, {p:5, c:'117'}, {p:7, c:'116', s:'é–±è®€'}],
        3: [{p:2, c:'109'}, {p:3, c:'116'}, {p:7, c:'117'}],
        4: [{p:1, c:'109'}, {p:3, c:'117'}, {p:4, c:'116'}, {p:6, c:'109', s:'é–±è®€'}],
        5: [{p:2, c:'116'}, {p:5, c:'117'}, {p:7, c:'109'}]
    };

    let g_currentDate = new Date();
    let g_records = {};
    let g_selectedMissing = {};

    function changeDate(d) { g_currentDate.setDate(g_currentDate.getDate() + d); render(); }

    function fetchData() {
        Papa.parse(csvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => {
                results.data.forEach(row => {
                    const key = `${row['æ—¥æœŸ']}_${row['ç¯€æ¬¡']}`;
                    g_records[key] = row;
                });
                render();
            }
        });
    }

    function parseNums(str) {
        if(!str) return [];
        return str.toString().split(/[,\s\u3001]+/).map(Number).filter(n => !isNaN(n) && n > 0);
    }

    function updateLink(id) {
        const item = document.getElementById(`in-${id}`).value;
        const missing = Array.from(g_selectedMissing[id] || []).sort((a,b)=>a-b).join(' ');
        const dateStr = g_currentDate.toISOString().split('T')[0];
        const p = id.split('-').pop();
        const btn = document.getElementById(`btn-${id}`);
        btn.href = `${formUrl}&${entryIds.date}=${dateStr}&${entryIds.period}=${p}&${entryIds.item}=${encodeURIComponent(item)}&${entryIds.missing}=${encodeURIComponent(missing)}`;
    }

    function toggleStudent(id, n, el) {
        if(!g_selectedMissing[id]) g_selectedMissing[id] = new Set();
        const s = g_selectedMissing[id];
        if(s.has(n)) { s.delete(n); el.classList.remove('missing'); }
        else { s.add(n); el.classList.add('missing'); }
        
        const msg = document.getElementById(`msg-${id}`);
        const panel = document.getElementById(`panel-${id}`);
        if(s.size === 0) { msg.style.display = 'block'; panel.classList.add('all-clear'); }
        else { msg.style.display = 'none'; panel.classList.remove('all-clear'); }
        updateLink(id);
    }

    function setItem(id, txt) {
        const input = document.getElementById(`in-${id}`);
        input.value = txt;
        document.querySelectorAll(`#chips-${id} .hw-chip`).forEach(c => {
            c.classList.toggle('active', c.innerText === txt);
        });
        updateLink(id);
    }

    function render() {
        const container = document.getElementById('mainContainer');
        const dateStr = g_currentDate.toISOString().split('T')[0];
        document.getElementById('dateDisplay').innerText = g_currentDate.toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
        
        const day = g_currentDate.getDay();
        const classes = timetable[day] || [];
        if(classes.length === 0) { container.innerHTML = '<div style="text-align:center; padding:40px;">â˜• ä»Šå¤©æ²’æœ‰æ’èª²ã€‚</div>'; return; }

        container.innerHTML = '';
        classes.forEach(c => {
            const id = `${dateStr}-${c.p}`;
            // æ‰¾è©²ç­ç´šæœ€å¾Œä¸€æ¬¡æœ‰ä½œæ¥­çš„ç´€éŒ„ (ç”¨ä¾†ç”ŸæˆæŒ‰éˆ•)
            const history = Object.values(g_records)
                .filter(r => r['ç¯€æ¬¡'] == c.p) // ç°¡åŒ–é‚è¼¯ï¼šæŠ“è©²ç¯€æ¬¡æœ€è¿‘çš„
                .sort((a,b) => b['æ—¥æœŸ'].localeCompare(a['æ—¥æœŸ']));
            
            const lastRow = history[0];

            let hwItems = [];
            if(lastRow) {
                if(lastRow['ä½œæ¥­å…§å®¹']) hwItems.push(...lastRow['ä½œæ¥­å…§å®¹'].split(/[ã€\n,ï¼Œ]/).map(s=>s.trim()));
                if(lastRow['å¹³æ™‚æ¸¬é©—']) hwItems.push(...lastRow['å¹³æ™‚æ¸¬é©—'].split(/[ã€\n,ï¼Œ]/).map(s=>s.trim()));
            }
            hwItems = [...new Set(hwItems)].filter(s => s && s !== 'ç„¡');

            const card = document.createElement('div');
            card.className = 'class-card';
            
            let initialMissing = lastRow ? parseNums(lastRow['ç¼ºäº¤åº§è™Ÿ']) : [];
            if(!g_selectedMissing[id]) g_selectedMissing[id] = new Set(initialMissing);

            card.innerHTML = `
                <div class="card-header">
                    <span>ç¬¬ ${c.p} ç¯€</span>
                    <span style="font-weight:bold;">${c.c} ç­ - ${c.s || 'åœ‹æ–‡'}</span>
                </div>
                <div class="card-body">
                    <div class="last-record">
                        <h4>ğŸ“… ä¸Šæ¬¡ç´€éŒ„ (${lastRow ? lastRow['æ—¥æœŸ'].slice(5) : 'ç„¡'})</h4>
                        <div>é€²åº¦ï¼š${lastRow ? (lastRow['æ•™å­¸é€²åº¦'] || 'ç„¡') : 'ç„¡'}</div>
                        <div style="color:#d84315;">ä½œæ¥­ï¼š${lastRow ? (lastRow['ä½œæ¥­å…§å®¹'] || 'ç„¡') : 'ç„¡'}</div>
                        <div style="color:#2e7d32;">æ¸¬é©—ï¼š${lastRow ? (lastRow['å¹³æ™‚æ¸¬é©—'] || 'ç„¡') : 'ç„¡'}</div>
                        <div>ç¼ºäº¤ï¼š${lastRow ? (lastRow['ç¼ºäº¤åº§è™Ÿ'] || 'ç„¡') : 'ç„¡'}</div>
                    </div>
                    <div class="check-panel" id="panel-${id}">
                        <strong>ğŸ” æª¢æŸ¥é …ç›®ï¼š</strong>
                        <div class="hw-chips" id="chips-${id}">
                            ${hwItems.map(h => `<div class="hw-chip" onclick="setItem('${id}','${h}')">${h}</div>`).join('')}
                            <div class="hw-chip" onclick="setItem('${id}','å…¨éƒ¨')">å…¨éƒ¨</div>
                        </div>
                        <input type="text" class="hw-input" id="in-${id}" placeholder="é»é¸ä¸Šæ–¹æŒ‰éˆ•æˆ–æ‰‹å‹•è¼¸å…¥..." oninput="updateLink('${id}')">
                        <div class="all-clear-msg" id="msg-${id}">ğŸ‰ æœ¬é …å…¨æ•¸ç¹³æ¸…ï¼</div>
                        <div class="number-grid">
                            ${Array.from({length:40}, (_,i)=>i+1).map(n => `
                                <div class="num-btn ${g_selectedMissing[id].has(n)?'missing':''}" onclick="toggleStudent('${id}',${n},this)">${n}</div>
                            `).join('')}
                        </div>
                    </div>
                    <a href="#" target="_blank" class="btn-submit" id="btn-${id}" onclick="this.innerText='âœ… å·²é–‹å•Ÿè¡¨å–®';">ğŸš€ å¡«å¯«é€²åº¦</a>
                </div>
            `;
            container.appendChild(card);
            updateLink(id);
        });
    }
    fetchData();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿ (æ™‚é–“è»¸è®Šè‰²ç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root { --primary-color: #4a6fa5; --bg-color: #f4f7f6; --card-bg: #ffffff; --accent-color: #d84315; --success-color: #2ecc71; --error-color: #e74c3c; }
        body { font-family: "Microsoft JhengHei", sans-serif; background-color: var(--bg-color); margin: 0; padding: 15px; }
        .header { text-align: center; margin-bottom: 20px; }
        .date-controls { display: flex; justify-content: center; align-items: center; gap: 15px; margin-top: 10px; }
        .nav-btn { background: white; border: 2px solid var(--primary-color); color: var(--primary-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 18px; }
        .date-display { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .container { max-width: 800px; margin: 0 auto; padding-bottom: 60px; }
        .class-card { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); margin-bottom: 25px; overflow: hidden; border-left: 6px solid var(--primary-color); }
        .card-header { background-color: #eef2f7; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .card-header .class-name { font-weight: bold; font-size: 1.1rem; color: #333; }
        .card-body { padding: 15px; }
        .last-record { background-color: #fff8e1; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffe0b2; font-size: 0.95rem; line-height: 1.6; }
        .last-record h4 { margin: 0 0 8px 0; color: #e65100; border-bottom: 1px dashed #ffcc80; font-size: 1rem; }
        .info-row { display: flex; margin-bottom: 4px; align-items: flex-start; }
        .info-label { min-width: 45px; font-weight: bold; color: #555; white-space: nowrap; }
        .info-content { flex: 1; word-break: break-word; white-space: pre-wrap; }
        .check-panel { background-color: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb; margin-bottom: 10px; }
        .check-panel.all-clear { background-color: #e8f5e9; border-color: #a5d6a7; }
        .panel-title { font-weight: bold; margin-bottom: 8px; color: #1565c0; display: block; }
        .hw-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        
        /* è—è‰²æŒ‰éˆ• (ä¸€èˆ¬ä½œæ¥­ / ç•¶æ—¥æª¢æŸ¥) */
        .hw-chip { background: white; border: 1px solid #90caf9; color: #1565c0; padding: 6px 14px; border-radius: 20px; cursor: pointer; font-size: 0.95rem; }
        .hw-chip.active { background: #1565c0; color: white; border-color: #1565c0; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        /* ç´…è‰²æŒ‰éˆ• (éæœŸæ¬ å‚µ / è£œäº¤) */
        .remedy-chip { border: 2px solid var(--error-color); color: var(--error-color); font-weight: bold; background: #fff5f5; }
        .remedy-chip.active { background: var(--error-color); color: white; border-color: var(--error-color); }
        
        .hw-input { width: 100%; padding: 10px; border: 1px solid #90caf9; border-radius: 4px; box-sizing: border-box; margin-bottom: 12px; font-size: 1rem; }
        .number-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(42px, 1fr)); gap: 8px; }
        .num-btn { height: 42px; border: 1px solid #bbdefb; background: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; color: #555; font-weight: 500; font-size: 1.1rem; }
        .num-btn.missing { background: var(--error-color); color: white; border-color: var(--error-color); font-weight: bold; transform: scale(1.05); }
        .btn-submit { display: block; width: 100%; text-align: center; background: var(--primary-color); color: white; padding: 16px; text-decoration: none; border-radius: 8px; font-weight: bold; margin-top: 15px; font-size: 1.1rem; border: none; }
        .all-clear-msg { color: var(--success-color); font-weight: bold; text-align: center; display: none; margin: 10px 0; font-size: 1.2rem; }
        .fab-refresh { position: fixed; bottom: 20px; right: 20px; background: var(--primary-color); color: white; width: 56px; height: 56px; border-radius: 50%; border: none; font-size: 26px; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div class="header">
    <h1>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</h1>
    <div class="date-controls">
        <button class="nav-btn" onclick="changeDate(-1)">â—€</button>
        <span class="date-display" id="dateDisplay"></span>
        <button class="nav-btn" onclick="changeDate(1)">â–¶</button>
    </div>
</div>

<div class="container" id="mainContainer">æ­£åœ¨è®€å–è³‡æ–™åº«...</div>
<button class="fab-refresh" onclick="location.reload()">â†»</button>

<script>
    // æ‚¨çš„ CSV ç¶²å€
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv'; 
    const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform?usp=pp_url';
    
    const entryIds = {
        date: 'entry.1279670059', period: 'entry.1620291828',
        progress: 'entry.244862663', homework: 'entry.1001982669',
        quiz: 'entry.476700209', note: 'entry.1079052023',
        item: 'entry.1450418126', missing: 'entry.551581621'
    };

    const timetable = {
        1: [{p:1, c:'109'}, {p:2, c:'117'}, {p:4, c:'116'}],
        2: [{p:2, c:'116'}, {p:3, c:'109'}, {p:5, c:'117'}, {p:7, c:'116', s:'é–±è®€'}],
        3: [{p:2, c:'109'}, {p:3, c:'116'}, {p:7, c:'117'}],
        4: [{p:1, c:'109'}, {p:3, c:'117'}, {p:4, c:'116'}, {p:6, c:'109', s:'é–±è®€'}],
        5: [{p:2, c:'116'}, {p:5, c:'117'}, {p:7, c:'109'}]
    };

    let g_currentDate = new Date();
    let g_rawRecords = []; 
    let g_selectedMissing = {}; 
    let g_itemMissingMap = {}; 

    function changeDate(d) { g_currentDate.setDate(g_currentDate.getDate() + d); render(); }

    function fetchData() {
        Papa.parse(csvUrl, {
            download: true, header: true, skipEmptyLines: true,
            complete: (results) => { g_rawRecords = results.data; render(); }
        });
    }

    function getClassByDateAndPeriod(dateStr, period) {
        const d = new Date(dateStr);
        const day = d.getDay(); 
        const classes = timetable[day];
        if (!classes) return null;
        const target = classes.find(c => c.p == period);
        return target ? target.c : null;
    }

    function parseNums(str) {
        if(!str) return [];
        return str.toString().split(/[,\s\u3001]+/).map(Number).filter(n => !isNaN(n) && n > 0);
    }

    function updateLink(id) {
        const item = document.getElementById(`in-${id}`).value;
        const missing = Array.from(g_selectedMissing[id] || []).sort((a,b)=>a-b).join(' ');
        const dateStr = g_currentDate.toISOString().split('T')[0];
        const p = id.split('-').pop(); 
        const btn = document.getElementById(`btn-${id}`);
        btn.href = `${formUrl}&${entryIds.date}=${dateStr}&${entryIds.period}=${p}&${entryIds.item}=${encodeURIComponent(item)}&${entryIds.missing}=${encodeURIComponent(missing)}`;
        
        refreshGrid(id);
    }

    function refreshGrid(id) {
        const currentSet = g_selectedMissing[id] || new Set();
        const grid = document.querySelector(`#panel-${id} .number-grid`);
        if(!grid) return;
        
        const msg = document.getElementById(`msg-${id}`);
        const panel = document.getElementById(`panel-${id}`);
        if(currentSet.size === 0) { msg.style.display = 'block'; panel.classList.add('all-clear'); }
        else { msg.style.display = 'none'; panel.classList.remove('all-clear'); }

        grid.querySelectorAll('.num-btn').forEach(btn => {
            const n = parseInt(btn.innerText);
            if(currentSet.has(n)) btn.classList.add('missing');
            else btn.classList.remove('missing');
        });
    }

    function toggleStudent(id, n, el) {
        if(!g_selectedMissing[id]) g_selectedMissing[id] = new Set();
        const s = g_selectedMissing[id];
        if(s.has(n)) { s.delete(n); }
        else { s.add(n); }
        updateLink(id);
    }

    function setItem(id, txt) {
        const input = document.getElementById(`in-${id}`);
        input.value = txt;

        document.querySelectorAll(`#chips-${id} .hw-chip`).forEach(c => {
            const fullText = c.innerText;
            // æ¯”å°æŒ‰éˆ•æ–‡å­—æ˜¯å¦èˆ‡è¼¸å…¥æ¡†å…§å®¹ç›¸ç¬¦
            c.classList.toggle('active', fullText === txt);
        });

        // å¦‚æœæ˜¯ã€Œè£œï¼š...ã€çš„æŒ‰éˆ•ï¼Œè¦å»æ‰å‰ç¶´å†å» Map æ‰¾è³‡æ–™
        let lookupName = txt;
        if (txt.startsWith("è£œï¼š")) {
            lookupName = txt.substring(2);
        }

        if (g_itemMissingMap[id] && g_itemMissingMap[id][lookupName]) {
             g_selectedMissing[id] = new Set(g_itemMissingMap[id][lookupName].nums);
        } else {
             // æ‰¾ä¸åˆ°å°±æ¸…ç©º (ä»£è¡¨æ˜¯æ–°ä½œæ¥­ï¼Œæˆ–æ˜¯å·²æ¸…ç©º)
             g_selectedMissing[id] = new Set();
        }

        updateLink(id);
    }

    function render() {
        const container = document.getElementById('mainContainer');
        const dateStr = g_currentDate.toISOString().split('T')[0]; // ç•¶å‰çœ‹æ¿æ—¥æœŸ
        document.getElementById('dateDisplay').innerText = g_currentDate.toLocaleDateString('zh-TW', {month:'long', day:'numeric', weekday:'long'});
        
        const day = g_currentDate.getDay();
        const classes = timetable[day] || [];
        if(classes.length === 0) { container.innerHTML = '<div style="text-align:center; padding:40px; color:#888;">â˜• ä»Šå¤©æ²’æœ‰æ’èª²ã€‚</div>'; return; }

        container.innerHTML = '';
        g_itemMissingMap = {}; 

        classes.forEach(c => {
            const id = `${dateStr}-${c.p}`; 
            
            // æ‰¾å‡ºè©²ç­æ­·å²ç´€éŒ„
            const history = g_rawRecords.filter(r => {
                const rClass = getClassByDateAndPeriod(r['æ—¥æœŸ'], r['ç¯€æ¬¡']);
                return rClass === c.c && r['æ—¥æœŸ'] <= dateStr; 
            }).sort((a,b) => b['æ—¥æœŸ'].localeCompare(a['æ—¥æœŸ']) || b['ç¯€æ¬¡'] - a['ç¯€æ¬¡']);
            
            const displayRow = history[0]; 

            // â˜… å»ºç«‹å…¨æ­·å²æ¬ å‚µæ¸…å–® (Map)
            // æ ¼å¼: { "ä½œæ¥­A": { nums: [1, 7], date: "2025-01-12" } }
            let classOutstanding = {}; 
            
            [...history].reverse().forEach(r => {
                const item = r['æª¢æŸ¥é …ç›®'];
                const nums = parseNums(r['ç¼ºäº¤åº§è™Ÿ']);
                const rDate = r['æ—¥æœŸ'];
                
                if (item) {
                    classOutstanding[item] = { nums: nums, date: rDate };
                }
            });

            g_itemMissingMap[id] = classOutstanding;

            // â˜… å€åˆ†æŒ‰éˆ•é¡å‹ï¼šè—è‰²(ä»Šæ—¥/æ–°) vs ç´…è‰²(éæœŸ)
            let blueButtons = new Set();
            let redButtons = [];

            // 1. è™•ç†æ­·å²æ¬ å‚µ (Outstanding)
            Object.keys(classOutstanding).forEach(item => {
                const data = classOutstanding[item];
                if (data.nums.length > 0) {
                    // é—œéµåˆ¤æ–·ï¼šé€™ç­†æ¬ å‚µæ˜¯ã€Œä»Šå¤©ã€ç™»è¨˜çš„å—ï¼Ÿ
                    if (data.date === dateStr) {
                        // æ˜¯ä»Šå¤©ç™»è¨˜çš„ -> ä¿æŒè—è‰² (Normal)
                        blueButtons.add(item);
                    } else {
                        // æ˜¯éå»ç™»è¨˜çš„ -> è®Šæˆç´…è‰² (Remedy)
                        redButtons.push({ name: item, label: `è£œï¼š${item}` });
                    }
                }
            });

            // 2. è™•ç†æ–°æŒ‡æ´¾/ä¸Šä¸€æ¬¡æŒ‡æ´¾çš„ä½œæ¥­ (åŠ å…¥è—è‰²æ¸…å–®)
            let rawHwList = [];
            // å¦‚æœä»Šå¤©å·²å¡«é€²åº¦ï¼ŒæŠ“ä¸Šä¸€å ‚çš„æŒ‡æ´¾ä½œæ¥­
            if(displayRow && displayRow['æ—¥æœŸ'] === dateStr && history.length > 1) {
                if(history[1]['ä½œæ¥­å…§å®¹']) rawHwList.push(...history[1]['ä½œæ¥­å…§å®¹'].split(/[ã€\n,ï¼Œ]/));
            } else if (displayRow) {
                // å¦‚æœä»Šå¤©é‚„æ²’å¡«ï¼ŒæŠ“æœ€æ–°ä¸€ç­†æŒ‡æ´¾ä½œæ¥­
                if(displayRow['ä½œæ¥­å…§å®¹']) rawHwList.push(...displayRow['ä½œæ¥­å…§å®¹'].split(/[ã€\n,ï¼Œ]/));
            }
            
            rawHwList.forEach(s => {
                const cleanName = s.trim();
                // åªæœ‰ç•¶å®ƒä¸åœ¨ã€Œç´…è‰²æ¸…å–®ã€è£¡æ™‚ï¼Œæ‰åŠ åˆ°è—è‰²æ¸…å–® (é¿å…é‡è¤‡)
                // é‚è¼¯ï¼šå¦‚æœä¸€å€‹ä½œæ¥­å·²ç¶“è®Šç´…è‰²æ¬ å‚µï¼Œå°±åªé¡¯ç¤ºç´…è‰²ï¼›
                // å¦‚æœæ˜¯ä»Šå¤©å‰›æª¢æŸ¥çš„(è—è‰²æ¬ å‚µ)ï¼Œå®ƒæœƒå·²ç¶“åœ¨ä¸Šé¢æ­¥é©Ÿè¢«åŠ å…¥ blueButtonsï¼Œé€™è£¡å†æ¬¡ add ä¹Ÿæ²’é—œä¿‚(Setç‰¹æ€§)
                const isRemedy = redButtons.some(rb => rb.name === cleanName);
                if(cleanName && cleanName !== 'ç„¡' && !isRemedy) {
                    blueButtons.add(cleanName);
                }
            });

            // é è¨­è¼‰å…¥é‚è¼¯ï¼šå„ªå…ˆè¼‰å…¥ç¬¬ä¸€å€‹ç´…è‰²è£œäº¤é …ç›®
            let initialLoadItem = '';
            let initialMissing = [];
            
            if (redButtons.length > 0) {
                // å¦‚æœæœ‰ç´…è‰²æ¬ å‚µï¼Œé è¨­é¡¯ç¤ºç¬¬ä¸€å€‹ç´…è‰²çš„
                initialLoadItem = redButtons[0].label;
                initialMissing = g_itemMissingMap[id][redButtons[0].name].nums;
            } else if (blueButtons.size > 0 && displayRow && displayRow['æ—¥æœŸ'] === dateStr) {
                 // å¦‚æœæ²’æœ‰ç´…è‰²ï¼Œä½†æœ‰è—è‰²ä¸”ä»Šå¤©æ˜¯å‰›æª¢æŸ¥å®Œçš„ç‹€æ…‹ï¼Œå˜—è©¦è¼‰å…¥ä»Šå¤©å‰›æª¢æŸ¥çš„ç´…å­—
                 // é€™è£¡éœ€è¦ç¨å¾®æ‰¾ä¸€ä¸‹ä»Šå¤©å‰›æª¢æŸ¥çš„æ˜¯å“ªå€‹é …ç›®
                 // ç°¡å–®èµ·è¦‹ï¼Œé€™è£¡ä¸è‡ªå‹•è¼‰å…¥è—è‰²ï¼Œè®“è€å¸«è‡ªå·±é»ï¼Œé™¤éè€å¸«å¸Œæœ›ã€‚
                 // ç‚ºäº†ä¸å¹²æ“¾ã€Œæ–°æª¢æŸ¥ã€ï¼Œè—è‰²é è¨­ä¸è¼‰å…¥ç´…å­—ï¼Œä¿æŒå…¨ç™½è®“è€å¸«é–‹å§‹é»ã€‚
            }
            
            if(!g_selectedMissing[id]) g_selectedMissing[id] = new Set(initialMissing);

            // æ§‹å»ºç´…å­—æé†’å­—ä¸² (Yellow Box)
            let missingSummary = [];
            // æŠŠç´…è‰²æ¬ å‚µçš„åŠ é€²å»
            redButtons.forEach(btn => {
                const count = classOutstanding[btn.name].nums.length;
                missingSummary.push(`<span style="color:#d32f2f;">[${btn.name}] ${count}äºº</span>`);
            });
            // æŠŠè—è‰²æ¬ å‚µ(ä»Šæ—¥å‰›é»çš„)ä¹ŸåŠ é€²å»
            blueButtons.forEach(name => {
                if(classOutstanding[name] && classOutstanding[name].nums.length > 0) {
                     // åªæœ‰ç•¶ç¢ºå¯¦æœ‰ç´…å­—æ‰é¡¯ç¤º
                     missingSummary.push(`<span>[${name}] ${classOutstanding[name].nums.length}äºº</span>`);
                }
            });
            
            let missingInfoStr = missingSummary.length > 0 ? missingSummary.join('ã€') : "ç„¡";


            const card = document.createElement('div');
            card.className = 'class-card';
            
            card.innerHTML = `
                <div class="card-header">
                    <span>ç¬¬ ${c.p} ç¯€</span>
                    <span class="class-name">${c.c} ç­</span>
                </div>
                <div class="card-body">
                    <div class="last-record">
                        <h4>ğŸ“… ä¸Šæ¬¡ç´€éŒ„ (${displayRow ? displayRow['æ—¥æœŸ'].slice(5) : 'ç„¡'})</h4>
                        <div class="info-row"><span class="info-label">é€²åº¦ï¼š</span><span class="info-content">${displayRow ? displayRow['æ•™å­¸é€²åº¦'] : 'ç„¡'}</span></div>
                        <div class="info-row" style="color:#d84315;"><span class="info-label">ä½œæ¥­ï¼š</span><span class="info-content">${displayRow ? displayRow['ä½œæ¥­å…§å®¹'] : 'ç„¡'}</span></div>
                        <div class="info-row"><span class="info-label">æ¬ ç¹³ï¼š</span><span class="info-content">${missingInfoStr}</span></div>
                    </div>
                    
                    <div class="check-panel" id="panel-${id}">
                        <span class="panel-title">ğŸ” è£œäº¤ / æª¢æŸ¥ç™»è¨˜</span>
                        <div class="hw-chips" id="chips-${id}">
                            ${redButtons.map(btn => `<div class="hw-chip remedy-chip" onclick="setItem('${id}','${btn.label}')">${btn.label}</div>`).join('')}
                            ${[...blueButtons].map(h => `<div class="hw-chip" onclick="setItem('${id}','${h}')">${h}</div>`).join('')}
                            <div class="hw-chip" onclick="setItem('${id}','å…¨éƒ¨')">å…¨éƒ¨</div>
                        </div>
                        <input type="text" class="hw-input" id="in-${id}" placeholder="é»æ“ŠæŒ‰éˆ•è‡ªå‹•å¸¶å…¥..." oninput="updateLink('${id}')" value="${initialLoadItem}">
                        <div class="all-clear-msg" id="msg-${id}">ğŸ‰ æœ¬é …å…¨æ•¸ç¹³æ¸…ï¼</div>
                        <div class="number-grid">
                            ${Array.from({length:40}, (_,i)=>i+1).map(n => `
                                <div class="num-btn ${g_selectedMissing[id].has(n)?'missing':''}" onclick="toggleStudent('${id}',${n},this)">${n}</div>
                            `).join('')}
                        </div>
                    </div>
                    <a href="#" target="_blank" class="btn-submit" id="btn-${id}">ğŸš€ å¡«å¯«é€²åº¦</a>
                </div>
            `;
            container.appendChild(card);
            updateLink(id);
        });
    }
    fetchData();
</script>
</body>
</html>

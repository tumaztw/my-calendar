<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --accent-color: #d84315;
        }
        body {
            font-family: "Microsoft JhengHei", "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .date-display {
            font-size: 1.3rem;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 10px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .class-card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            margin-bottom: 25px;
            overflow: hidden;
            border-left: 6px solid var(--primary-color);
            transition: transform 0.2s;
        }
        .class-card:hover {
            transform: translateY(-2px);
        }
        .card-header {
            background-color: #eef2f7;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #eee;
        }
        .period-badge {
            background-color: var(--primary-color);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .class-title {
            font-size: 1.25rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .card-body {
            padding: 20px;
        }
        .last-record {
            background-color: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.95rem;
            border: 1px solid #ffe0b2;
        }
        .last-record h4 {
            margin: 0 0 12px 0;
            color: var(--accent-color);
            font-size: 1rem;
            display: flex;
            align-items: center;
            border-bottom: 1px dashed #ffcc80;
            padding-bottom: 8px;
        }
        .record-item {
            margin-bottom: 8px;
            line-height: 1.6;
            display: flex;
        }
        .record-label {
            font-weight: bold;
            color: var(--text-sub);
            min-width: 50px;
            flex-shrink: 0;
        }
        .record-content {
            word-break: break-word;
        }
        .btn-add {
            display: block;
            width: 100%;
            text-align: center;
            background-color: var(--primary-color);
            color: white;
            padding: 14px;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.05rem;
            transition: background 0.3s;
        }
        .btn-add:hover {
            background-color: #36527a;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-sub);
            font-size: 1.1rem;
        }
        .no-class {
            text-align: center;
            padding: 50px;
            background: white;
            border-radius: 12px;
            color: var(--text-sub);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        /* é–±è®€æŒ‡å°èª²æ¨£å¼ */
        .type-reading {
            border-left-color: #2e7d32;
        }
        .type-reading .period-badge {
            background-color: #2e7d32;
        }
        .type-reading .btn-add {
            background-color: #2e7d32;
        }
        .type-reading .btn-add:hover {
            background-color: #1b5e20;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</h1>
    <div class="date-display" id="currentDate"></div>
</div>

<div class="container" id="scheduleContainer">
    <div class="loading">
        <p>â³ æ­£åœ¨è¼‰å…¥èª²è¡¨èˆ‡é›²ç«¯é€²åº¦...</p>
    </div>
</div>

<script>
    // ==========================================
    // â˜… è¨­å®šå€
    // ==========================================
    
    // 1. Google Sheet ç™¼å¸ƒçš„ CSV ç¶²å€
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv';

    // 2. è¡¨å–®åŸºç¤ç¶²å€ (ä¿®æ­£é‡é»ï¼šåŠ å…¥ ?usp=pp_url)
    const formBaseUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform?usp=pp_url';
    
    // 3. è¡¨å–®æ¬„ä½ ID (ç”¨æ–¼è‡ªå‹•å¡«å¯«æ—¥æœŸèˆ‡ç¯€æ¬¡)
    const entryIds = {
        date: 'entry.1279670059',
        period: 'entry.1620291828'
    };

    // 4. èª²è¡¨è³‡æ–™åº« (æ ¹æ“š PDF å»ºç«‹)
    //    Key: æ˜ŸæœŸå¹¾ (1-5), Value: èª²ç¨‹åˆ—è¡¨
    const timetable = {
        1: [
            { period: 1, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 2, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 4, class: '116', subject: 'åœ‹èªæ–‡' }
        ],
        2: [
            { period: 2, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 3, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 5, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 7, class: '116', subject: 'é–±è®€æŒ‡å°' }
        ],
        3: [
            { period: 2, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 3, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 7, class: '117', subject: 'åœ‹èªæ–‡' }
        ],
        4: [
            { period: 1, class: '109', subject: 'åœ‹èªæ–‡' },
            { period: 3, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 4, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 6, class: '109', subject: 'é–±è®€æŒ‡å°' }
        ],
        5: [
            { period: 2, class: '116', subject: 'åœ‹èªæ–‡' },
            { period: 5, class: '117', subject: 'åœ‹èªæ–‡' },
            { period: 7, class: '109', subject: 'åœ‹èªæ–‡' }
        ]
    };

    // ==========================================
    // â˜… ç¨‹å¼é‚è¼¯å€
    // ==========================================

    document.addEventListener('DOMContentLoaded', () => {
        updateDateDisplay();
        fetchData();
    });

    function updateDateDisplay() {
        const now = new Date();
        const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
        document.getElementById('currentDate').textContent = now.toLocaleDateString('zh-TW', options);
    }

    function fetchData() {
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            complete: function(results) {
                // æˆåŠŸæŠ“å–å¾Œï¼Œè™•ç†è³‡æ–™
                processAndRender(results.data);
            },
            error: function(err) {
                console.error("Error fetching CSV:", err);
                document.getElementById('scheduleContainer').innerHTML = 
                    '<div class="no-class">ç„¡æ³•è®€å–è³‡æ–™ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚</div>';
            }
        });
    }

    // å°‡ (æ—¥æœŸ+ç¯€æ¬¡) è½‰æ›ç‚º (ç­ç´š) çš„è¼”åŠ©å‡½å¼
    function getClassByDateAndPeriod(dateStr, period) {
        // dateStr æ ¼å¼é æœŸç‚º 2025-12-19
        const dateObj = new Date(dateStr);
        if (isNaN(dateObj)) return null;

        const dayOfWeek = dateObj.getDay(); // 0-6
        if (!timetable[dayOfWeek]) return null;

        // æ¯”å°ç¯€æ¬¡ (CSVä¸­çš„ç¯€æ¬¡ vs èª²è¡¨ä¸­çš„ç¯€æ¬¡)
        // æ³¨æ„ï¼šCSV çš„ period å¯èƒ½æ˜¯å­—ä¸²ï¼Œè¦è½‰æˆæ•¸å­—æ¯”å°
        const course = timetable[dayOfWeek].find(c => c.period == period);
        return course ? course.class : null;
    }

    function processAndRender(csvData) {
        // 1. æ•´ç† CSV è³‡æ–™ï¼Œå°‡æ¯ä¸€ç­†ç´€éŒ„æ¨™ä¸Š "ç­ç´š"
        // ä¸¦ä¸”ä¾ç­ç´šåˆ†çµ„ï¼Œæ‰¾å‡ºæ¯å€‹ç­ç´šçš„æœ€æ–°ç´€éŒ„
        const classRecords = {}; 

        csvData.forEach(row => {
            // å°æ‡‰æ‚¨æä¾›çš„ CSV æ¬„ä½åç¨±
            const date = row['æ—¥æœŸ']; 
            const period = row['ç¯€æ¬¡']; 
            
            if (date && period) {
                // è‡ªå‹•æ¨ç®—é€™ä¸€ç­†ç´€éŒ„æ˜¯å“ªå€‹ç­ç´šçš„
                const className = getClassByDateAndPeriod(date, period);
                
                if (className) {
                    // å¦‚æœé€™å€‹ç­ç´šé‚„æ²’æœ‰ç´€éŒ„ï¼Œæˆ–é€™ç­†ç´€éŒ„æ¯”ç›®å‰çš„ç´€éŒ„æ›´æ–°
                    if (!classRecords[className] || date > classRecords[className]['æ—¥æœŸ']) {
                        classRecords[className] = row;
                    }
                }
            }
        });

        renderSchedule(classRecords);
    }

    function renderSchedule(lastRecords) {
        const container = document.getElementById('scheduleContainer');
        container.innerHTML = '';

        const now = new Date();
        const dayOfWeek = now.getDay();
        const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD for form pre-fill

        if (!timetable[dayOfWeek]) {
            container.innerHTML = '<div class="no-class">â˜• ä»Šå¤©æ²’æœ‰æ’å®šçš„èª²ç¨‹ï¼Œå¥½å¥½ä¼‘æ¯ï¼</div>';
            return;
        }

        const todaysClasses = timetable[dayOfWeek];

        // ä¾ç¯€æ¬¡å¾å°åˆ°å¤§æ’åº
        todaysClasses.sort((a, b) => a.period - b.period);

        todaysClasses.forEach(course => {
            const lastRecord = lastRecords[course.class];
            
            // ä¿®æ­£è™•ï¼šé€™è£¡çš„é€£çµæœƒæ˜¯ viewform?usp=pp_url&entry...ï¼Œé€™æ˜¯æ­£ç¢ºçš„æ ¼å¼
            const formLink = `${formBaseUrl}&${entryIds.date}=${dateStr}&${entryIds.period}=${course.period}`;

            const card = document.createElement('div');
            card.className = `class-card ${course.subject === 'é–±è®€æŒ‡å°' ? 'type-reading' : ''}`;
            
            let recordHtml = '';
            if (lastRecord) {
                recordHtml = `
                    <div class="last-record">
                        <h4>ğŸ“… ä¸Šæ¬¡é€²åº¦ (${lastRecord['æ—¥æœŸ']} - ç¬¬ ${lastRecord['ç¯€æ¬¡']} ç¯€)</h4>
                        <div class="record-item">
                            <span class="record-label">é€²åº¦ï¼š</span>
                            <span class="record-content">${lastRecord['æ•™å­¸é€²åº¦'] || 'ç„¡'}</span>
                        </div>
                        <div class="record-item">
                            <span class="record-label">ä½œæ¥­ï¼š</span>
                            <span class="record-content">${lastRecord['ä½œæ¥­å…§å®¹'] || 'ç„¡'}</span>
                        </div>
                        <div class="record-item">
                            <span class="record-label">æé†’ï¼š</span>
                            <span class="record-content">${lastRecord['èª²å ‚æé†’'] || 'ç„¡'}</span>
                        </div>
                        ${lastRecord['å¹³æ™‚æ¸¬é©—'] ? `
                        <div class="record-item">
                            <span class="record-label">æ¸¬é©—ï¼š</span>
                            <span class="record-content">${lastRecord['å¹³æ™‚æ¸¬é©—']}</span>
                        </div>` : ''}
                    </div>
                `;
            } else {
                recordHtml = `
                    <div class="last-record" style="background-color: #f5f5f5; border:none; color: #888;">
                        å°šç„¡æ­¤ç­ç´š (${course.class}) çš„éå¾€ç´€éŒ„
                    </div>
                `;
            }

            card.innerHTML = `
                <div class="card-header">
                    <span class="period-badge">ç¬¬ ${course.period} ç¯€</span>
                    <span class="class-title">${course.class} ç­ - ${course.subject}</span>
                </div>
                <div class="card-body">
                    ${recordHtml}
                    <a href="${formLink}" target="_blank" class="btn-add">
                        âœï¸ å¡«å¯«æœ¬æ—¥é€²åº¦
                    </a>
                </div>
            `;
            container.appendChild(card);
        });
    }
</script>

</body>
</html>

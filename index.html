<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸æ—¥èªŒ - ä»Šæ—¥èª²è¡¨ç‰ˆ</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --history-bg: #fff9db; --today-btn: #e3faf2; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* ä¸Šæ–¹æ­·å²é¡¯ç¤ºå€ */
        .history-panel { background: var(--history-bg); padding: 12px; border-radius: 10px; border: 1px solid #f5e79e; margin-bottom: 15px; }
        .history-title { font-weight: bold; color: #856404; font-size: 0.9rem; margin-bottom: 5px; border-bottom: 1px solid #f5e79e; }
        .history-content { font-size: 0.95rem; color: #333; line-height: 1.4; }

        /* ä»Šæ—¥èª²è¡¨æŒ‰éˆ•å€ */
        .today-schedule { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 20px; }
        .class-btn { padding: 12px; border: 1px solid #c3e6cb; background: var(--today-btn); border-radius: 8px; cursor: pointer; text-align: center; transition: 0.2s; }
        .class-btn:hover { background: #d4edda; }
        .class-btn.active { background: var(--accent); color: white; border-color: var(--accent); }
        .class-btn small { display: block; font-size: 0.75rem; opacity: 0.8; }

        .form-group { margin-bottom: 12px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 16px; }
        textarea { height: 60px; }
        
        button.submit-btn { width: 100%; padding: 15px; background: var(--primary); color: white; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer; }
        #loading { text-align: center; color: var(--accent); font-size: 0.8rem; display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="text-align:center; margin:0 0 15px 0; color:var(--primary);">ğŸ“… ä»Šæ—¥æ•™å­¸èˆ‡é€²åº¦</h2>

    <div id="historySection" class="history-panel">
        <div class="history-title">ğŸ’¡ å…ˆå‰ç´€éŒ„å…§å®¹ (è«‹å…ˆé¸æ“‡ä¸‹æ–¹èª²è¡¨)</div>
        <div id="hist_info" class="history-content">é»æ“Šä¸‹æ–¹èª²è¡¨æŒ‰éˆ•ï¼Œè‡ªå‹•æŠ“å–ä¸Šæ¬¡é€²åº¦...</div>
    </div>

    <div style="font-weight:bold; margin-bottom:10px; font-size:0.9rem;">ğŸš© ä»Šæ—¥èª²è¡¨å¿«é€Ÿé¸æ“‡ï¼š</div>
    <div id="todayBtns" class="today-schedule">
        </div>

    <hr>

    <div id="loading">ğŸ“¡ æ­£åœ¨åŒæ­¥é›²ç«¯è³‡æ–™...</div>

    <form id="progressForm" action="https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/formResponse" method="post" target="hidden_iframe">
        <input type="hidden" name="entry.1620291828" id="field_date">
        <input type="hidden" name="entry.244862663" id="field_period">

        <div class="form-group">
            <label id="selectedLabel">è«‹é¸æ“‡ä¸€ç¯€èª²...</label>
        </div>

        <div class="form-group">
            <label>ğŸ“– æ•™å­¸é€²åº¦æ›´æ–°</label>
            <textarea name="entry.1001982669" id="in_progress"></textarea>
        </div>

        <div class="form-group">
            <label>ğŸ”” èª²å ‚æé†’</label>
            <textarea name="entry.476700209" id="in_reminder"></textarea>
        </div>

        <div class="form-group">
            <label>ğŸ“ ä½œæ¥­å…§å®¹</label>
            <textarea name="entry.1079052023" id="in_homework"></textarea>
        </div>

        <div class="form-group">
            <label>âœï¸ å¹³æ™‚æ¸¬é©—</label>
            <textarea name="entry.1279670059" id="in_quiz"></textarea>
        </div>

        <button type="submit" class="submit-btn" onclick="submitted=true">ğŸ’¾ å„²å­˜ä»Šæ—¥é€²åº¦</button>
    </form>
</div>

<iframe name="hidden_iframe" id="hidden_iframe" style="display:none;" onload="if(typeof submitted !== 'undefined' && submitted){alert('ç´€éŒ„æˆåŠŸï¼'); location.reload();}"></iframe>

<script>
    const SHEET_ID = '1SlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD';
    
    // æ‚¨çš„å›ºå®šèª²è¡¨
    const mySchedule = {
        1: [{p:1, n:"109 åœ‹æ–‡"}, {p:2, n:"117 åœ‹æ–‡"}, {p:4, n:"116 åœ‹æ–‡"}],
        2: [{p:2, n:"116 åœ‹æ–‡"}, {p:3, n:"109 åœ‹æ–‡"}, {p:5, n:"117 åœ‹æ–‡"}, {p:7, n:"116 é–±è®€"}],
        3: [{p:2, n:"109 åœ‹æ–‡"}, {p:3, n:"116 åœ‹æ–‡"}, {p:7, n:"117 åœ‹æ–‡"}],
        4: [{p:1, n:"109 åœ‹æ–‡"}, {p:3, n:"117 åœ‹æ–‡"}, {p:4, n:"116 åœ‹æ–‡"}, {p:6, n:"109 é–±è®€"}],
        5: [{p:2, n:"116 åœ‹æ–‡"}, {p:5, n:"117 åœ‹æ–‡"}, {p:7, n:"109 åœ‹æ–‡"}]
    };

    window.onload = function() {
        const now = new Date();
        const day = now.getDay(); // 0-6
        const dateStr = now.toISOString().split('T')[0];
        document.getElementById('field_date').value = dateStr;

        const btnContainer = document.getElementById('todayBtns');
        const todayClasses = mySchedule[day] || [];

        if(todayClasses.length === 0) {
            btnContainer.innerHTML = "<div style='grid-column:1/3; text-align:center; color:grey;'>ä»Šæ—¥ç„¡æ’èª²</div>";
        }

        todayClasses.forEach(item => {
            const btn = document.createElement('div');
            btn.className = 'class-btn';
            btn.innerHTML = `<small>ç¬¬ ${item.p} ç¯€</small><b>${item.n}</b>`;
            btn.onclick = () => selectClass(item.p, item.n, btn);
            btnContainer.appendChild(btn);
        });
    };

    async function selectClass(period, className, btnElem) {
        // UI å›é¥‹
        document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
        btnElem.classList.add('active');
        document.getElementById('field_period').value = period;
        document.getElementById('selectedLabel').innerText = `ğŸ“ ç›®å‰é¸å–ï¼šç¬¬ ${period} ç¯€ ${className}`;
        
        // é–‹å§‹æŠ“å–æ­·å²
        document.getElementById('loading').style.display = 'block';
        document.getElementById('hist_info').innerText = "é€£ç·šé›²ç«¯ä¸­...";

        try {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv`;
            const resp = await fetch(url);
            const csv = await resp.text();
            const rows = csv.split('\n').map(r => r.split('","').map(c => c.replace(/"/g, '')));
            
            // å°‹æ‰¾ã€Œæœ€å¾Œä¸€æ¬¡ã€ä¸Šé€™é–€èª²çš„ç´€éŒ„
            // æˆ‘å€‘ä¸é™æ—¥æœŸï¼Œåªçœ‹é€™ç¯€èª²(Period)æœ€æ–°çš„ç´€éŒ„
            let found = null;
            for (let i = rows.length - 1; i >= 0; i--) {
                // å‡è¨­ç¬¬ 2 æ¬„æ˜¯ç¯€æ¬¡ (Index 2)
                if (rows[i][2] == period) {
                    found = rows[i];
                    break;
                }
            }

            if (found) {
                const info = `
                    <b>æ—¥æœŸï¼š</b>${found[1]}<br>
                    <b>é€²åº¦ï¼š</b>${found[3] || 'ç„¡'}<br>
                    <b>æé†’ï¼š</b>${found[4] || 'ç„¡'}<br>
                    <b>ä½œæ¥­ï¼š</b>${found[5] || 'ç„¡'}
                `;

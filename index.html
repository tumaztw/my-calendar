<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        :root {
            --primary-color: #4a6fa5;   /* è—è‰² (ä¸€èˆ¬/é ç¿’) */
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #333;
            --text-sub: #666;
            --accent-color: #ff9800;    /* æ©˜è‰² (ä¸Šèª²ä¸­) */
            --pending-color: #9c27b0;   /* ç´«è‰² (ä¸‹èª²æœªå¡«) */
            --success-color: #28a745;   /* ç¶ è‰² (å·²å®Œæˆ) */
        }

        body {
            font-family: "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 20px;
        }

        /* æ¨™é¡Œèˆ‡æ—¥æœŸ */
        .header { text-align: center; margin-bottom: 30px; }
        .date-display { 
            display: inline-block; background: white; padding: 8px 25px; 
            border-radius: 50px; font-weight: bold; color: var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd;
        }

        /* å®¹å™¨èˆ‡å¡ç‰‡ */
        .container { max-width: 750px; margin: 0 auto; }
        .class-card {
            background: var(--card-bg); border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 25px; overflow: hidden;
            border-left: 10px solid var(--primary-color);
            transition: 0.3s;
        }
        
        /* ç‹€æ…‹é‚Šæ¢é¡è‰² */
        .class-card.active-now { border-left-color: var(--accent-color); box-shadow: 0 6px 15px rgba(255, 152, 0, 0.2); }
        .class-card.status-pending { border-left-color: var(--pending-color); }
        .class-card.is-done { border-left-color: var(--success-color); }

        .card-header {
            background-color: #f8f9fa; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .period-badge {
            background: var(--primary-color); color: white;
            padding: 6px 18px; border-radius: 20px; font-weight: bold; font-size: 1.1rem;
        }
        .class-title { font-weight: bold; font-size: 1.2rem; color: #2c3e50; }

        .card-body { padding: 20px; }

        /* é€²åº¦å€å¡Š (é»ƒè‰²æ¡†) */
        .progress-box {
            background-color: #fff8e1; border: 1px solid #ffe0b2;
            padding: 15px; border-radius: 10px; margin-bottom: 10px;
        }
        .progress-box h4 { margin: 0 0 10px 0; color: #e65100; border-bottom: 1px dashed #ffcc80; padding-bottom: 5px; }
        .progress-item { line-height: 1.7; font-size: 1rem; color: #444; }

        /* ğŸš€ æŒ‰éˆ•æ ¸å¿ƒæ¨£å¼ */
        .btn-main {
            display: block; width: 100%; text-align: center;
            padding: 15px; border-radius: 10px; text-decoration: none;
            font-weight: bold; font-size: 1.1rem; margin-top: 15px;
            background-color: var(--primary-color); color: white;
            transition: 0.3s; border: none; cursor: pointer;
        }

        /* ä¸Šèª²ä¸­ï¼šæ©˜è‰²æŒ‰éˆ• + è„ˆå‹•å‹•ç•« */
        .active-now .btn-main { 
            background-color: var(--accent-color); 
            animation: pulse-orange 2s infinite; 
        }
        
        /* ä¸‹èª²æœªå¡«ï¼šç´«è‰²æŒ‰éˆ• */
        .status-pending .btn-main { background-color: var(--pending-color); }

        /* å·²å¡«å¯«ï¼šç¶ è‰²æŒ‰éˆ• */
        .btn-main.updated { 
            background-color: var(--success-color) !important; 
            cursor: default; pointer-events: none;
        }

        @keyframes pulse-orange {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }

        /* åº•éƒ¨æŒ‰éˆ• */
        .fab-refresh {
            position: fixed; bottom: 30px; right: 30px;
            background: var(--primary-color); color: white;
            width: 55px; height: 55px; border-radius: 50%; border: none;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; font-size: 20px;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>å¼µè€å¸«æ•™å­¸é€²åº¦çœ‹æ¿</h1>
    <div class="date-display" id="dateText">è¼‰å…¥æ—¥æœŸä¸­...</div>
</div>

<div class="container" id="cardContainer">
    </div>

<button class="fab-refresh" onclick="location.reload()">â†»</button>

<script>
    // é…ç½®æ‚¨çš„é€£çµ
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSlivRAYD4jjOxvWWQ71eRKXfXG1pBr8oqr1k2d4h_Gq8Bt6evj_x-XQzlTV_DzhK9k8W1XEbqA2ljD/pub?output=csv';
    const formUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSfgyKNluqNR1uo1kM89Jh4wp6yHs9Quisz_9OprFS9AcialXQ/viewform?usp=pp_url';
    
    // é å¡«æ¬„ä½ ID (èˆ‡æ‚¨ä¹‹å‰çš„è¨­å®šä¸€è‡´)
    const entryDate = 'entry.1279670059';
    const entryPeriod = 'entry.1620291828';

    // èª²è¡¨ (1=ä¸€, 2=äºŒ...)
    const timetable = {
        1: [{p:1, c:'109'}, {p:2, c:'117'}, {p:4, c:'116'}],
        2: [{p:2, c:'116'}, {p:3, c:'109'}, {p:5, c:'117'}],
        3: [{p:2, c:'109'}, {p:3, c:'116'}, {p:7, c:'117'}],
        4: [{p:1, c:'109'}, {p:3, c:'117'}, {p:4, c:'116'}],
        5: [{p:2, c:'116'}, {p:5, c:'117'}, {p:7, c:'109'}]
    };

    // æ™‚é–“è¨­å®š
    const periodTimes = {
        1:['08:15','09:05'], 2:['09:15','10:00'], 3:['10:10','10:55'], 4:['11:05','11:50'],
        5:['13:30','14:15'], 6:['14:25','15:10'], 7:['15:20','16:05'], 8:['16:15','17:00']
    };

    let g_date = new Date();
    let g_csv = [];

    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
        showDate();
        fetchData();
    });

    function showDate() {
        const opt = { year:'numeric', month:'long', day:'numeric', weekday:'long' };
        document.getElementById('dateText').innerText = g_date.toLocaleDateString('zh-TW', opt);
    }

    function fetchData() {
        Papa.parse(csvUrl, {
            download: true, header: true,
            complete: (results) => {
                g_csv = results.data;
                renderCards();
            }
        });
    }

    function checkStatus(p) {
        const now = new Date();
        const cur = now.getHours()*60 + now.getMinutes();
        const [sH, sM] = periodTimes[p][0].split(':').map(Number);
        const [eH, eM] = periodTimes[p][1].split(':').map(Number);
        if (cur >= (sH*60+sM) && cur <= (eH*60+eM)) return 'now';
        if (cur > (eH*60+eM)) return 'past';
        return 'future';
    }

    function renderCards() {
        const container = document.getElementById('cardContainer');
        const day = g_date.getDay();
        const dateKey = `${g_date.getFullYear()}-${String(g_date.getMonth() + 1).padStart(2, '0')}-${String(g_date.getDate()).padStart(2, '0')}`;

        if (!timetable[day]) {
            container.innerHTML = '<div class="no-class">â˜• ä»Šå¤©æ²’èª²å–”ï¼</div>';
            return;
        }

        container.innerHTML = '';
        timetable[day].forEach(item => {
            const status = checkStatus(item.p);
            const storageId = `done_${dateKey}_${item.c}_${item.p}`;
            const isDone = localStorage.getItem(storageId) === 'true';

            // æ‰¾æœ€æ–°é€²åº¦
            const last = g_csv.filter(r => r.ç­ç´š == item.c).sort((a,b) => new Date(b.æ—¥æœŸ) - new Date(a.æ—¥æœŸ))[0];

            let cardClass = '';
            let btnText = 'âœï¸ å¡«å¯«é€²åº¦';
            if (isDone) { cardClass = 'is-done'; btnText = 'âœ… å·²æ›´æ–°ç•¶å¤©æ–°é€²åº¦'; }
            else if (status === 'now') { cardClass = 'active-now'; btnText = 'ğŸš€ ç«‹å³å¡«å¯«é€²åº¦'; }
            else if (status === 'past') { cardClass = 'status-pending'; btnText = 'ğŸ”” å·²å®Œæˆèª²ç¨‹ï¼Œæ›´æ–°æ•™å­¸é€²åº¦'; }

            const card = document.createElement('div');
            card.className = `class-card ${cardClass}`;
            card.innerHTML = `
                <div class="card-header">
                    <span class="period-badge">ç¬¬ ${item.p} ç¯€</span>
                    <span class="class-title">${item.c} ç­ - åœ‹èªæ–‡</span>
                </div>
                <div class="card-body">
                    <div class="progress-box">
                        <h4>ğŸ“… ä¸Šæ¬¡é€²åº¦ (${last ? last.æ—¥æœŸ : 'ç„¡'})</h4>
                        <div class="progress-item"><b>é€²åº¦ï¼š</b>${last ? last.æ•™å­¸é€²åº¦ : 'å°šç„¡è³‡æ–™'}</div>
                        <div class="progress-item"><b>ä½œæ¥­ï¼š</b>${last ? last.ä½œæ¥­å…§å®¹ : 'å°šç„¡è³‡æ–™'}</div>
                    </div>
                    <button class="btn-main ${isDone ? 'updated' : ''}" 
                            onclick="handleUpdate(this, '${storageId}', '${dateKey}', ${item.p})">
                        ${btnText}
                    </button>
                </div>
            `;
            container.appendChild(card);
        });
    }

    function handleUpdate(btn, id, date, p) {
        localStorage.setItem(id, 'true');
        btn.innerText = "âœ… å·²æ›´æ–°ç•¶å¤©æ–°é€²åº¦";
        btn.classList.add('updated');
        btn.closest('.class-card').className = 'class-card is-done';
        const finalUrl = `${formUrl}&${entryDate}=${date}&${entryPeriod}=${p}`;
        window.open(finalUrl, '_blank');
    }
</script>
</body>
</html>
